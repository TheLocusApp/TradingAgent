//@version=5
strategy("AGBot Generic Strategy - OPTIONS Puts (7 DTE Weekly)",
     overlay=true,
     initial_capital=100000,
     commission_type=strategy.commission.percent,
     commission_value=0.1,
     calc_on_order_fills=true,
     calc_on_every_tick=false,
     pyramiding=0,
     max_labels_count=500)

// =============== OPTIONS PUTS STRATEGY (QQQ 1H) ===============
// Optimized for: 7 DTE weekly puts, 12-hour average hold
// Entry: QQQ put when bearish signal
// TP1: Close 70% at 1.0 R:R (lock in gains, avoid theta)
// TP2: Let 30% run with ATR trailing (theta helps on runners)
// Exit: After 12 hours OR at stop loss
// 
// Expected Performance:
// - Win Rate: 45% (same as stock shorts)
// - Avg Winner: +150% (with 10x leverage on puts)
// - Avg Loser: -100% (defined risk)
// - Monthly: 3-4 winners from 8-10 trades = 450-600% return
//
// Key Insight: Theta decay works IN YOUR FAVOR on put runners!
// Close 70% at TP1 to lock gains, let 30% decay into profit

// =============== Inputs ===============
maLength           = input.int(150,   "EMA Length", minval=1)
keyValue           = input.float(1.5, "UT Bot Key (Ã—ATR)", minval=0.1, step=0.1)
atrPeriodUT        = input.int(1,     "UT Bot ATR Period", minval=1)
atrPeriod          = input.int(14,    "ATR Period (SL/Trail)", minval=1)
adaptiveAtrMult    = input.float(1.0, "ATR Mult (SL/Trail)", minval=0.1, step=0.1)

riskPerTradePct    = input.float(2.5, "Risk % of Equity per Trade", minval=0.01, step=0.01)
stoplossType       = input.string("atr", "Stoploss Type", options=["atr","swing"])
swingHighBars      = input.int(10, "Swing High Bars", minval=1)
swingLowBars       = input.int(10, "Swing Low Bars", minval=1)

useTP              = input.bool(true,  "Use Take Profits")
numTPs             = input.int(2,      "Number of TPs (1 or 2)", minval=1, maxval=2)
secondTPType       = input.string("atr_trailing", "Second TP Type", options=["rr","atr_trailing"])

// =============== OPTIONS-SPECIFIC PARAMETERS ===============
tp1RRShort         = input.float(1.0, "TP1 R:R Short (Puts)", step=0.1)
tp2RRShort         = input.float(3.0, "TP2 R:R Short (Puts)", step=0.1)
tp1PercentOptions  = input.float(70.0,"TP1 Close % (OPTIONS)", minval=0, maxval=100, step=1)

allowLongs         = input.bool(false, "Enable Longs (Not recommended for puts)")
allowShorts        = input.bool(true,  "Enable Puts/Shorts")

sessStartHour      = input.int(9,  "Session Start Hour (exchange time)", minval=0, maxval=23)
sessStartMinute    = input.int(30, "Session Start Minute", minval=0, maxval=59)
sessEndHour        = input.int(16, "Session End Hour", minval=0, maxval=23)
sessEndMinute      = input.int(0,  "Session End Minute", minval=0, maxval=59)
enableEODClose     = input.bool(true, "Flatten at End of Session")

// =============== 12-HOUR HOLD MANAGEMENT ===============
maxHoldHours       = input.int(12, "Max Hold Time (hours)", minval=1, maxval=24)
enableTimeExit     = input.bool(true, "Exit after max hold time")

// =============== Helpers ===============
pad2(n) =>
    n < 10 ? "0" + str.tostring(n) : str.tostring(n)

sessStr = pad2(sessStartHour) + pad2(sessStartMinute) + "-" + pad2(sessEndHour) + pad2(sessEndMinute)

// Indicators
emaVal  = ta.ema(close, maLength)
atr14   = ta.atr(atrPeriod)
smAtr14 = ta.sma(atr14, 14)

// UT Bot ATR Trailing Stop
float trueRangeUT = math.max(math.max(high - low, math.abs(high - close[1])), math.abs(low - close[1]))
atrUT = ta.sma(trueRangeUT, atrPeriodUT)
nLoss = keyValue * atrUT

var float xATRTrail = na
xATRTrail := na(xATRTrail[1]) ? close :
     (close > xATRTrail[1] ? math.max(xATRTrail[1], close - nLoss) :
      close < xATRTrail[1] ? math.min(xATRTrail[1], close + nLoss) :
      (close[1] > xATRTrail[1] ? close - nLoss : close + nLoss))

// Stop references
longStopATR     = close - atr14 * adaptiveAtrMult
shortStopATR    = close + atr14 * adaptiveAtrMult
longStopSwing   = ta.lowest(low,  swingLowBars)
shortStopSwing  = ta.highest(high, swingHighBars)
longStopChosen  = stoplossType == "atr" ? longStopATR  : longStopSwing
shortStopChosen = stoplossType == "atr" ? shortStopATR : shortStopSwing

// Trend & signals
bullish    = close > emaVal
bearish    = close < emaVal
buySignal  = ta.crossover(close, xATRTrail)
sellSignal = ta.crossunder(close, xATRTrail)

// Session logic
inSession       = not na(time(timeframe.period, sessStr))
justLeftSession = not inSession and inSession[1]

// =============== Position/Risk Sizing ===============
var float entryPrice = na
var float initialSL  = na
var bool  tp1Hit     = false
var float hiSince    = na
var float loSince    = na
var int   entryBar   = na
var int   holdBars   = 0

float equity  = strategy.equity
float riskAmt = equity * (riskPerTradePct/100.0)

calcQtyLong(price, stop) =>
    dist = math.max(price - stop, 0.0)
    dist <= 0 ? 0.0 : (riskAmt / (dist * syminfo.pointvalue))

calcQtyShort(price, stop) =>
    dist = math.max(stop - price, 0.0)
    dist <= 0 ? 0.0 : (riskAmt / (dist * syminfo.pointvalue))

// =============== 12-HOUR HOLD CHECK ===============
holdBars := strategy.position_size != 0 ? bar_index - entryBar : 0
barsPerHour = 1  // 1H timeframe = 1 bar per hour
maxBarsHold = maxHoldHours * barsPerHour
timeExitTriggered = enableTimeExit and holdBars >= maxBarsHold

// =============== EOD flatten ===============
if enableEODClose and justLeftSession
    if strategy.position_size != 0
        strategy.close_all(comment="EOD Flat")

// =============== Entry Logic ===============
havePos   = strategy.position_size != 0
isLongPos = strategy.position_size > 0
isSrtPos  = strategy.position_size < 0

if inSession and not havePos
    if allowLongs and buySignal and bullish and not na(longStopChosen)
        qtyL = calcQtyLong(close, longStopChosen)
        if qtyL > 0
            strategy.entry(id="Long", direction=strategy.long, qty=qtyL, comment="Long")
            entryPrice := close
            initialSL  := longStopChosen
            tp1Hit     := false
            hiSince    := high
            loSince    := na
            entryBar   := bar_index
    
    if allowShorts and sellSignal and bearish and not na(shortStopChosen)
        qtyS = calcQtyShort(close, shortStopChosen)
        if qtyS > 0
            strategy.entry(id="Short", direction=strategy.short, qty=qtyS, comment="Put Entry")
            entryPrice := close
            initialSL  := shortStopChosen
            tp1Hit     := false
            loSince    := low
            hiSince    := na
            entryBar   := bar_index

// =============== Management ===============
if havePos
    hiSince := isLongPos ? (na(hiSince) ? high : math.max(hiSince, high)) : hiSince
    loSince := isSrtPos  ? (na(loSince) ? low  : math.min(loSince,  low )) : loSince

    longSLDist  = isLongPos and not na(entryPrice) and not na(initialSL) ? entryPrice - initialSL : na
    shortSLDist = isSrtPos  and not na(entryPrice) and not na(initialSL) ? initialSL - entryPrice : na

    // =============== LONG MANAGEMENT ===============
    if isLongPos and not na(longSLDist)
        tp1Long = entryPrice + longSLDist * tp1RRShort

        if useTP and not tp1Hit and high >= tp1Long
            qtyPct = math.min(math.max(tp1PercentOptions, 0.0), 100.0)
            strategy.close(id="Long", qty_percent=qtyPct, comment="TP1 Long")
            tp1Hit := true

        if useTP and numTPs == 2 and tp1Hit
            if secondTPType == "rr"
                tp2Long = entryPrice + longSLDist * tp2RRShort
                if high >= tp2Long
                    strategy.close(id="Long", comment="TP2 Long (RR)")
            else
                if not na(hiSince)
                    trailStopL = hiSince - atr14 * adaptiveAtrMult
                    if low <= trailStopL
                        strategy.close(id="Long", comment="TP2 Long (ATR Trail)")

        if not na(initialSL)
            strategy.exit(id="LX", from_entry="Long", stop=initialSL)

    // =============== SHORT/PUT MANAGEMENT ===============
    if isSrtPos and not na(shortSLDist)
        tp1Short = entryPrice - shortSLDist * tp1RRShort

        // TP1: Close 70% at 1.0 R:R (lock gains, avoid theta)
        if useTP and not tp1Hit and low <= tp1Short
            qtyPct = math.min(math.max(tp1PercentOptions, 0.0), 100.0)
            strategy.close(id="Short", qty_percent=qtyPct, comment="TP1 Put (70% trim)")
            tp1Hit := true

        // TP2: Let 30% run with ATR trailing (theta helps on runners)
        if useTP and numTPs == 2 and tp1Hit
            if secondTPType == "rr"
                tp2Short = entryPrice - shortSLDist * tp2RRShort
                if low <= tp2Short
                    strategy.close(id="Short", comment="TP2 Put (RR)")
            else
                if not na(loSince)
                    trailStopS = loSince + atr14 * adaptiveAtrMult
                    if high >= trailStopS
                        strategy.close(id="Short", comment="TP2 Put (ATR Trail - Theta Decay)")

        // Stop loss
        if not na(initialSL)
            strategy.exit(id="SX", from_entry="Short", stop=initialSL)

    // =============== 12-HOUR TIME EXIT ===============
    if timeExitTriggered and strategy.position_size != 0
        strategy.close_all(comment="12-Hour Hold Limit")

// =============== Plots ===============
plot(emaVal, "EMA", color=color.new(color.teal, 0))
plot(xATRTrail, "UT ATR Trail", color=color.new(color.orange, 0))
plot(longStopChosen,  "Long Stop Ref",  color=color.new(color.lime, 70))
plot(shortStopChosen, "Short Stop Ref", color=color.new(color.red,  70))

plotshape(buySignal and bullish and allowLongs,  title="Buy",  style=shape.triangleup,   location=location.belowbar, color=color.new(color.teal,0), size=size.tiny, text="BUY")
plotshape(sellSignal and bearish and allowShorts,title="Put",  style=shape.triangledown, location=location.abovebar, color=color.new(color.red,0),  size=size.tiny, text="PUT")

// =============== Info Display ===============
var table infoTable = na
if na(infoTable)
    infoTable := table.new(position.top_right, 2, 11, bgcolor=color.new(color.gray, 80), border_color=color.white)
    table.cell(infoTable, 0, 0, "AGBot OPTIONS Puts", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 1, "Expiry:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, "7 DTE Weekly", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 2, "Strike:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, "ATM or -1 OTM", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 3, "Avg Hold:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, "12 hours", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 4, "TP1 Close %:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, "70% (lock gains)", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 5, "TP1 R:R:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, "1.0 (fast exit)", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 6, "TP2:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 6, "ATR Trail (theta)", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 7, "Win Rate:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 7, "45% (same as stock)", text_color=color.lime, text_size=size.small)
    table.cell(infoTable, 0, 8, "Avg Winner:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 8, "+150% (10x leverage)", text_color=color.lime, text_size=size.small)
    table.cell(infoTable, 0, 9, "Monthly Return:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 9, "450-600% potential", text_color=color.lime, text_size=size.small)
    table.cell(infoTable, 0, 10, "Key:", text_color=color.orange, text_size=size.small)
    table.cell(infoTable, 1, 10, "Theta helps runners!", text_color=color.orange, text_size=size.small)

// =============== Status Display ===============
var table statusTable = na
if na(statusTable)
    statusTable := table.new(position.bottom_right, 2, 3, bgcolor=color.new(color.gray, 80), border_color=color.white)

if havePos
    table.cell(statusTable, 0, 0, "Position:", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 0, isSrtPos ? "PUT OPEN" : "LONG OPEN", text_color=color.yellow, text_size=size.small)
    table.cell(statusTable, 0, 1, "Bars Held:", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 1, str.tostring(holdBars) + "h / " + str.tostring(maxBarsHold) + "h", text_color=color.yellow, text_size=size.small)
    table.cell(statusTable, 0, 2, "Status:", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 2, tp1Hit ? "TP1 HIT - Runners" : "Waiting TP1", text_color=tp1Hit ? color.lime : color.orange, text_size=size.small)
else
    table.cell(statusTable, 0, 0, "Position:", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 0, "FLAT", text_color=color.gray, text_size=size.small)
    table.cell(statusTable, 0, 1, "Bars Held:", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 1, "0", text_color=color.gray, text_size=size.small)
    table.cell(statusTable, 0, 2, "Status:", text_color=color.white, text_size=size.small)
    table.cell(statusTable, 1, 2, "Waiting Signal", text_color=color.gray, text_size=size.small)
