//@version=5
strategy("AGBot Generic Strategy - UNIFIED Longs & Shorts (VIX-Based)",
     overlay=true,
     initial_capital=100000,
     commission_type=strategy.commission.percent,
     commission_value=0.1,
     calc_on_order_fills=true,
     calc_on_every_tick=false,
     pyramiding=0,
     max_labels_count=500)

// =============== UNIFIED STRATEGY (LONGS + SHORTS) ===============
// Automatically switches between longs and shorts based on VIX
// Bull Market (VIX < 20): Trade longs only
// Bear Market (VIX > 25): Trade shorts/puts only
// Sideways (VIX 20-25): Trade both (hedged)
//
// This combines:
// - AGBotGeneric_META_Optimized.pine (longs)
// - AGBotGeneric_OPTIONS_Puts_Strategy.pine (shorts)

// =============== REGIME DETECTION (VIX-Based) ===============
vixBullThreshold   = input.float(20.0, "VIX Bull Threshold", minval=10, maxval=30)
vixBearThreshold   = input.float(25.0, "VIX Bear Threshold", minval=15, maxval=40)
useVixRegime       = input.bool(true,  "Use VIX-Based Regime Detection")

// Get VIX from external source
vixValue = request.security("VIX", "D", close)

// Regime detection
isBullRegime = vixValue < vixBullThreshold
isBearRegime = vixValue > vixBearThreshold
isSidewaysRegime = not isBullRegime and not isBearRegime

// Manual override
manualMode = input.string("auto", "Mode", options=["auto", "longs_only", "shorts_only", "both"])
overrideLongs = manualMode == "longs_only" or manualMode == "both"
overrideShorts = manualMode == "shorts_only" or manualMode == "both"

// Final decision
allowLongsTrading = useVixRegime ? (isBullRegime or isSidewaysRegime) : overrideLongs
allowShortsTrading = useVixRegime ? (isBearRegime or isSidewaysRegime) : overrideShorts

// =============== Inputs ===============
maLength           = input.int(100,   "EMA Length", minval=1)
keyValue           = input.float(2.0, "UT Bot Key (Ã—ATR)", minval=0.1, step=0.1)
atrPeriodUT        = input.int(1,     "UT Bot ATR Period", minval=1)
atrPeriod          = input.int(14,    "ATR Period (SL/Trail)", minval=1)

// LONGS parameters
adaptiveAtrMultLongs = input.float(2.0, "ATR Mult Longs (SL/Trail)", minval=0.1, step=0.1)
tp1RRLong          = input.float(1.0, "TP1 R:R Long", step=0.1)
tp2RRLong          = input.float(3.0, "TP2 R:R Long", step=0.1)
tp1PercentLongs    = input.float(35.0,"TP1 Close % Longs", minval=0, maxval=100, step=1)

// SHORTS parameters
adaptiveAtrMultShorts = input.float(1.0, "ATR Mult Shorts (SL/Trail)", minval=0.1, step=0.1)
tp1RRShort         = input.float(1.0, "TP1 R:R Short", step=0.1)
tp2RRShort         = input.float(3.0, "TP2 R:R Short", step=0.1)
tp1PercentShorts   = input.float(70.0,"TP1 Close % Shorts", minval=0, maxval=100, step=1)

riskPerTradePct    = input.float(2.5, "Risk % of Equity per Trade", minval=0.01, step=0.01)
stoplossType       = input.string("atr", "Stoploss Type", options=["atr","swing"])
swingHighBars      = input.int(10, "Swing High Bars", minval=1)
swingLowBars       = input.int(10, "Swing Low Bars", minval=1)

useTP              = input.bool(true,  "Use Take Profits")
numTPs             = input.int(2,      "Number of TPs (1 or 2)", minval=1, maxval=2)
secondTPType       = input.string("atr_trailing", "Second TP Type", options=["rr","atr_trailing"])

sessStartHour      = input.int(9,  "Session Start Hour (exchange time)", minval=0, maxval=23)
sessStartMinute    = input.int(30, "Session Start Minute", minval=0, maxval=59)
sessEndHour        = input.int(16, "Session End Hour", minval=0, maxval=23)
sessEndMinute      = input.int(0,  "Session End Minute", minval=0, maxval=59)
enableEODClose     = input.bool(true, "Flatten at End of Session")

maxHoldHours       = input.int(12, "Max Hold Time (hours)", minval=1, maxval=24)
enableTimeExit     = input.bool(true, "Exit after max hold time")

// =============== Helpers ===============
pad2(n) =>
    n < 10 ? "0" + str.tostring(n) : str.tostring(n)

sessStr = pad2(sessStartHour) + pad2(sessStartMinute) + "-" + pad2(sessEndHour) + pad2(sessEndMinute)

// Indicators
emaVal  = ta.ema(close, maLength)
atr14   = ta.atr(atrPeriod)
smAtr14 = ta.sma(atr14, 14)

// UT Bot ATR Trailing Stop
float trueRangeUT = math.max(math.max(high - low, math.abs(high - close[1])), math.abs(low - close[1]))
atrUT = ta.sma(trueRangeUT, atrPeriodUT)
nLoss = keyValue * atrUT

var float xATRTrail = na
xATRTrail := na(xATRTrail[1]) ? close :
     (close > xATRTrail[1] ? math.max(xATRTrail[1], close - nLoss) :
      close < xATRTrail[1] ? math.min(xATRTrail[1], close + nLoss) :
      (close[1] > xATRTrail[1] ? close - nLoss : close + nLoss))

// Stop references - DYNAMIC based on regime
adaptiveAtrMult = allowShortsTrading and not allowLongsTrading ? adaptiveAtrMultShorts : adaptiveAtrMultLongs

longStopATR     = close - atr14 * adaptiveAtrMult
shortStopATR    = close + atr14 * adaptiveAtrMult
longStopSwing   = ta.lowest(low,  swingLowBars)
shortStopSwing  = ta.highest(high, swingHighBars)
longStopChosen  = stoplossType == "atr" ? longStopATR  : longStopSwing
shortStopChosen = stoplossType == "atr" ? shortStopATR : shortStopSwing

// Trend & signals
bullish    = close > emaVal
bearish    = close < emaVal
buySignal  = ta.crossover(close, xATRTrail)
sellSignal = ta.crossunder(close, xATRTrail)

// Session logic
inSession       = not na(time(timeframe.period, sessStr))
justLeftSession = not inSession and inSession[1]

// =============== Position/Risk Sizing ===============
var float entryPrice = na
var float initialSL  = na
var bool  tp1Hit     = false
var float hiSince    = na
var float loSince    = na
var int   entryBar   = na
var int   holdBars   = 0

float equity  = strategy.equity
float riskAmt = equity * (riskPerTradePct/100.0)

calcQtyLong(price, stop) =>
    dist = math.max(price - stop, 0.0)
    dist <= 0 ? 0.0 : (riskAmt / (dist * syminfo.pointvalue))

calcQtyShort(price, stop) =>
    dist = math.max(stop - price, 0.0)
    dist <= 0 ? 0.0 : (riskAmt / (dist * syminfo.pointvalue))

// =============== 12-HOUR HOLD CHECK ===============
holdBars := strategy.position_size != 0 ? bar_index - entryBar : 0
barsPerHour = 1  // 1H timeframe = 1 bar per hour
maxBarsHold = maxHoldHours * barsPerHour
timeExitTriggered = enableTimeExit and holdBars >= maxBarsHold

// =============== EOD flatten ===============
if enableEODClose and justLeftSession
    if strategy.position_size != 0
        strategy.close_all(comment="EOD Flat")

// =============== Entry Logic ===============
havePos   = strategy.position_size != 0
isLongPos = strategy.position_size > 0
isSrtPos  = strategy.position_size < 0

if inSession and not havePos
    if allowLongsTrading and buySignal and bullish and not na(longStopChosen)
        qtyL = calcQtyLong(close, longStopChosen)
        if qtyL > 0
            strategy.entry(id="Long", direction=strategy.long, qty=qtyL, comment="Long")
            entryPrice := close
            initialSL  := longStopChosen
            tp1Hit     := false
            hiSince    := high
            loSince    := na
            entryBar   := bar_index
    
    if allowShortsTrading and sellSignal and bearish and not na(shortStopChosen)
        qtyS = calcQtyShort(close, shortStopChosen)
        if qtyS > 0
            strategy.entry(id="Short", direction=strategy.short, qty=qtyS, comment="Short/Put")
            entryPrice := close
            initialSL  := shortStopChosen
            tp1Hit     := false
            loSince    := low
            hiSince    := na
            entryBar   := bar_index

// =============== Management ===============
if havePos
    hiSince := isLongPos ? (na(hiSince) ? high : math.max(hiSince, high)) : hiSince
    loSince := isSrtPos  ? (na(loSince) ? low  : math.min(loSince,  low )) : loSince

    longSLDist  = isLongPos and not na(entryPrice) and not na(initialSL) ? entryPrice - initialSL : na
    shortSLDist = isSrtPos  and not na(entryPrice) and not na(initialSL) ? initialSL - entryPrice : na

    // =============== LONG MANAGEMENT ===============
    if isLongPos and not na(longSLDist)
        tp1Long = entryPrice + longSLDist * tp1RRLong

        if useTP and not tp1Hit and high >= tp1Long
            qtyPct = math.min(math.max(tp1PercentLongs, 0.0), 100.0)
            strategy.close(id="Long", qty_percent=qtyPct, comment="TP1 Long")
            tp1Hit := true

        if useTP and numTPs == 2 and tp1Hit
            if secondTPType == "rr"
                tp2Long = entryPrice + longSLDist * tp2RRLong
                if high >= tp2Long
                    strategy.close(id="Long", comment="TP2 Long (RR)")
            else
                if not na(hiSince)
                    trailStopL = hiSince - atr14 * adaptiveAtrMult
                    if low <= trailStopL
                        strategy.close(id="Long", comment="TP2 Long (ATR Trail)")

        if not na(initialSL)
            strategy.exit(id="LX", from_entry="Long", stop=initialSL)

    // =============== SHORT/PUT MANAGEMENT ===============
    if isSrtPos and not na(shortSLDist)
        tp1Short = entryPrice - shortSLDist * tp1RRShort

        if useTP and not tp1Hit and low <= tp1Short
            qtyPct = math.min(math.max(tp1PercentShorts, 0.0), 100.0)
            strategy.close(id="Short", qty_percent=qtyPct, comment="TP1 Short")
            tp1Hit := true

        if useTP and numTPs == 2 and tp1Hit
            if secondTPType == "rr"
                tp2Short = entryPrice - shortSLDist * tp2RRShort
                if low <= tp2Short
                    strategy.close(id="Short", comment="TP2 Short (RR)")
            else
                if not na(loSince)
                    trailStopS = loSince + atr14 * adaptiveAtrMult
                    if high >= trailStopS
                        strategy.close(id="Short", comment="TP2 Short (ATR Trail)")

        if not na(initialSL)
            strategy.exit(id="SX", from_entry="Short", stop=initialSL)

    // =============== 12-HOUR TIME EXIT ===============
    if timeExitTriggered and strategy.position_size != 0
        strategy.close_all(comment="12-Hour Hold Limit")

// =============== Plots ===============
plot(emaVal, "EMA", color=color.new(color.teal, 0))
plot(xATRTrail, "UT ATR Trail", color=color.new(color.orange, 0))
plot(longStopChosen,  "Long Stop Ref",  color=color.new(color.lime, 70))
plot(shortStopChosen, "Short Stop Ref", color=color.new(color.red,  70))

plotshape(buySignal and bullish and allowLongsTrading,  title="Buy",  style=shape.triangleup,   location=location.belowbar, color=color.new(color.teal,0), size=size.tiny, text="BUY")
plotshape(sellSignal and bearish and allowShortsTrading,title="Sell", style=shape.triangledown, location=location.abovebar, color=color.new(color.red,0),  size=size.tiny, text="SELL")

// =============== Regime Display ===============
var table regimeTable = na
if na(regimeTable)
    regimeTable := table.new(position.top_left, 2, 4, bgcolor=color.new(color.gray, 80), border_color=color.white)
    table.cell(regimeTable, 0, 0, "REGIME DETECTOR", text_color=color.white, text_size=size.small)

regimeColor = isBullRegime ? color.green : (isBearRegime ? color.red : color.orange)
regimeText = isBullRegime ? "BULL" : (isBearRegime ? "BEAR" : "SIDEWAYS")

table.cell(regimeTable, 0, 1, "VIX:", text_color=color.white, text_size=size.small)
table.cell(regimeTable, 1, 1, str.tostring(vixValue, "#.##"), text_color=color.yellow, text_size=size.small)
table.cell(regimeTable, 0, 2, "Regime:", text_color=color.white, text_size=size.small)
table.cell(regimeTable, 1, 2, regimeText, text_color=regimeColor, text_size=size.small)
table.cell(regimeTable, 0, 3, "Trading:", text_color=color.white, text_size=size.small)
tradingMode = (allowLongsTrading ? "L" : "") + (allowShortsTrading ? "S" : "")
table.cell(regimeTable, 1, 3, tradingMode, text_color=color.yellow, text_size=size.small)

// =============== Info Display ===============
var table infoTable = na
if na(infoTable)
    infoTable := table.new(position.top_right, 2, 10, bgcolor=color.new(color.gray, 80), border_color=color.white)
    table.cell(infoTable, 0, 0, "AGBot UNIFIED", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 1, "Mode:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 1, "VIX-Based", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 2, "Bull Threshold:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(vixBullThreshold, "#.##"), text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 3, "Bear Threshold:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 3, str.tostring(vixBearThreshold, "#.##"), text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 4, "Longs TP1%:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 4, str.tostring(tp1PercentLongs, "#") + "%", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 5, "Shorts TP1%:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 5, str.tostring(tp1PercentShorts, "#") + "%", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 6, "Longs ATR Mult:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 6, str.tostring(adaptiveAtrMultLongs, "#.##"), text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 7, "Shorts ATR Mult:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 7, str.tostring(adaptiveAtrMultShorts, "#.##"), text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 8, "Max Hold:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 8, str.tostring(maxHoldHours) + "h", text_color=color.yellow, text_size=size.small)
    table.cell(infoTable, 0, 9, "Status:", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 9, "Ready", text_color=color.lime, text_size=size.small)
