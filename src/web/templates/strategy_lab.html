<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Lab - Moon Dev Trading</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-style.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="nav-links">
                <a href="/strategy-lab" class="active">BACKTEST LAB</a>
                <a href="/analyst">ANALYST</a>
                <a href="/">LIVE AGENTS</a>
                <a href="/portfolio">PORTFOLIO</a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        
        <!-- Strategy Input Section -->
        <div class="chart-section">
            <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">
                <i class="fas fa-lightbulb"></i> Submit Strategy Ideas
            </h2>
            
            <div style="background: #1a1a24; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
                    <!-- Left: Textarea -->
                    <div>
                        <div style="color: #9ca3af; font-size: 14px; margin-bottom: 12px;">
                            Enter one or more trading strategy ideas (one per line). The AI will research each strategy and generate backtests.
                        </div>
                        <textarea 
                            id="strategyIdeas"
                            placeholder="Enter strategy ideas (one per line):

RSI divergence with MACD confirmation
Moving average crossover on 4H timeframe
Bollinger Band squeeze breakout strategy
https://youtube.com/watch?v=... (YouTube strategy video)
Support/resistance bounce with volume confirmation"
                            style="width: 100%; min-height: 200px; background: #0f0f16; border: 1px solid #2d2d3d; border-radius: 8px; padding: 16px; color: #fff; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical;"
                        ></textarea>
                    </div>
                    
                    <!-- Right: RBI Settings Stacked -->
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- RBI Agent Version -->
                        <div>
                            <label style="display: block; color: #9ca3af; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-robot"></i> RBI Agent Version
                            </label>
                            <select id="rbiAgentVersion" style="width: 100%; background: #0f0f16; border: 1px solid #2d2d3d; border-radius: 6px; padding: 10px; color: #fff; font-size: 13px;">
                                <option value="v3">V3 (Optimized - Recommended)</option>
                                <option value="v2">V2 (Full Execution Loop)</option>
                                <option value="v2_simple">V2 Simple (Fast)</option>
                                <option value="v1">V1 (Classic)</option>
                            </select>
                        </div>
                        
                        <!-- AI Model -->
                        <div>
                            <label style="display: block; color: #9ca3af; font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-brain"></i> AI Model
                            </label>
                            <select id="aiModel" style="width: 100%; background: #0f0f16; border: 1px solid #2d2d3d; border-radius: 6px; padding: 10px; color: #fff; font-size: 13px;">
                                <option value="deepseek">DeepSeek (Fast & Cheap)</option>
                                <option value="openai">OpenAI (GPT-4o)</option>
                                <option value="claude">Claude (Opus)</option>
                                <option value="gemini">Gemini (Flash)</option>
                                <option value="xai">xAI Grok</option>
                            </select>
                        </div>
                        
                        <!-- Enable RL Optimization -->
                        <div style="display: flex; align-items: center; padding-top: 4px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="enableRL" style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="color: #fff; font-weight: 600; font-size: 13px;">Enable RL Optimization</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- Analysis Mode Selector -->
            <div style="background: #1a1a24; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <!-- Single Agent Mode -->
                    <label style="cursor: pointer;">
                        <input type="radio" name="analysisMode" value="single" checked style="display: none;">
                        <div class="mode-card" id="singleModeCard" style="background: #6366f1; border: 2px solid #6366f1; border-radius: 8px; padding: 14px; transition: all 0.3s; height: 100%;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="font-size: 24px;">‚ö°</div>
                                    <div>
                                        <div style="color: #fff; font-weight: 600; font-size: 14px;">Single Agent</div>
                                        <div style="color: rgba(255,255,255,0.8); font-size: 11px;">Fast analysis</div>
                                    </div>
                                </div>
                                <select id="singleAgentModel" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 6px 12px; color: #fff; font-size: 12px; min-width: 140px;">
                                    <option value="gpt-5">GPT-5</option>
                                    <option value="claude">Claude 4.5</option>
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="grok">Grok</option>
                                </select>
                            </div>
                        </div>
                    </label>
                    
                    <!-- Swarm Mode -->
                    <label style="cursor: pointer;">
                        <input type="radio" name="analysisMode" value="swarm" style="display: none;">
                        <div class="mode-card" id="swarmModeCard" style="background: #1a1a24; border: 2px solid #2d2d3d; border-radius: 8px; padding: 14px; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <div style="font-size: 24px;">üêù</div>
                                <div>
                                    <div style="color: #fff; font-weight: 600; font-size: 14px;">Swarm Mode</div>
                                    <div style="color: #9ca3af; font-size: 11px;">Multi-model consensus</div>
                                </div>
                            </div>
                            <div style="color: #6b7280; font-size: 11px; line-height: 1.4;">
                                GPT-5, Claude, DeepSeek, Grok
                            </div>
                        </div>
                    </label>
                    
                    <!-- Batch Mode -->
                    <label style="cursor: pointer;">
                        <input type="radio" name="analysisMode" value="batch" style="display: none;">
                        <div class="mode-card" id="batchModeCard" style="background: #1a1a24; border: 2px solid #2d2d3d; border-radius: 8px; padding: 14px; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <div style="font-size: 24px;">üîÑ</div>
                                <div>
                                    <div style="color: #fff; font-weight: 600; font-size: 14px;">Batch Mode</div>
                                    <div style="color: #9ca3af; font-size: 11px;">Test 10+ strategies</div>
                                </div>
                            </div>
                            <div style="color: #6b7280; font-size: 11px; line-height: 1.4;">
                                Auto-fix errors, compare results
                            </div>
                        </div>
                    </label>
                </div>
                
                <!-- Batch Upload Section (shown when batch mode selected) -->
                <div id="batchUploadSection" style="display: none; margin-top: 20px;">
                    <div style="background: #1a1a24; border: 2px solid #2d2d3d; border-radius: 8px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="color: #fff; font-weight: 600; font-size: 16px;">Batch Strategies</div>
                            <button onclick="showAddStrategyModal()" style="background: #6366f1; color: #fff; padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
                                <i class="fas fa-plus"></i> Add Strategy
                            </button>
                        </div>
                        <div id="batchStrategiesList" style="min-height: 100px;">
                            <div style="text-align: center; color: #6b7280; padding: 20px;">
                                No strategies added yet. Click "Add Strategy" to begin.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button 
                onclick="submitStrategies()"
                id="submitBtn"
                style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; padding: 14px 32px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;"
            >
                <i class="fas fa-rocket"></i> Research & Backtest Strategies
            </button>
        </div>
        
        <!-- Processing Queue -->
        <div id="processingSection" style="display: none; margin-top: 24px;">
            <div class="chart-section">
                <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">
                    <i class="fas fa-tasks"></i> Processing Queue
                </h2>
                <div id="processingQueue"></div>
            </div>
        </div>
        
        <!-- Results Comparison Table -->
        <div id="resultsSection" style="display: none; margin-top: 24px;">
            <div class="chart-section">
                <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">
                    <i class="fas fa-chart-bar"></i> Backtest Results Comparison
                </h2>
                <div style="overflow-x: auto;">
                    <table id="resultsTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="background: #1a1a24; border-bottom: 2px solid #6366f1;">
                                <th style="padding: 12px; text-align: left; color: #fff; font-weight: 600; font-size: 12px;">Strategy</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Ticker</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Timeframe</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Period</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Mode</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Return</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Buy&Hold</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Win Rate</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Sharpe</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Max DD</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;" title="Risk Rating: A=Excellent, B=Good, C=Average, D=Poor, F=High Risk">Risk <i class="fas fa-info-circle" style="font-size: 10px; opacity: 0.7;"></i></th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Trades</th>
                                <th style="padding: 12px; text-align: center; color: #fff; font-weight: 600; font-size: 12px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Strategy Details Modal -->
        <div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
            <div style="max-width: 1200px; margin: 40px auto; background: #12121a; border-radius: 12px; padding: 32px; position: relative;">
                <button onclick="closeDetails()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer;">
                    √ó
                </button>
                <div id="detailsContent"></div>
            </div>
        </div>
        
        <!-- Add Strategy Modal -->
        <div id="addStrategyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
            <div style="max-width: 600px; margin: 80px auto; background: #12121a; border-radius: 12px; padding: 32px; position: relative;">
                <button onclick="closeAddStrategyModal()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer;">
                    √ó
                </button>
                <h2 style="color: #fff; font-size: 24px; font-weight: 700; margin-bottom: 24px;">
                    <i class="fas fa-plus-circle"></i> Add Strategy
                </h2>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: #9ca3af; font-size: 14px; font-weight: 600; margin-bottom: 8px;">Strategy Description</label>
                    <textarea id="newStrategyText" placeholder="e.g., RSI divergence with MACD confirmation on SPY (swing trade)" style="width: 100%; min-height: 120px; background: #1a1a24; border: 1px solid #2d2d3d; border-radius: 8px; padding: 12px; color: #fff; font-size: 14px; resize: vertical;"></textarea>
                    <div style="color: #6b7280; font-size: 12px; margin-top: 6px;">Describe your trading strategy idea</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button onclick="addStrategyToBatch()" style="flex: 1; background: #6366f1; color: #fff; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-check"></i> Add Strategy
                    </button>
                    <button onclick="closeAddStrategyModal()" style="background: #2d2d3d; color: #9ca3af; padding: 12px 24px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let strategies = [];
        
        // Load saved backtest results from localStorage
        function loadSavedResults() {
            try {
                const saved = localStorage.getItem('backtest_results');
                if (saved) {
                    strategies = JSON.parse(saved);
                    console.log(`Loaded ${strategies.length} saved backtest results`);
                    
                    // Clear processing queue on page refresh - only keep completed/failed strategies
                    const beforeCount = strategies.length;
                    strategies = strategies.filter(s => s.status === 'completed' || s.status === 'failed');
                    const clearedCount = beforeCount - strategies.length;
                    
                    if (clearedCount > 0) {
                        console.log(`üßπ Cleared ${clearedCount} in-progress strategies from queue`);
                        saveResults(); // Save the cleaned list
                    }
                    
                    if (strategies.length > 0) {
                        document.getElementById('resultsSection').style.display = 'block';
                        updateResultsTable();
                    }
                }
            } catch (e) {
                console.error('Error loading saved results:', e);
            }
        }
        
        // Save backtest results to localStorage
        function saveResults() {
            try {
                localStorage.setItem('backtest_results', JSON.stringify(strategies));
                console.log(`Saved ${strategies.length} backtest results`);
            } catch (e) {
                console.error('Error saving results:', e);
            }
        }
        
        // Mode switching
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved results on page load
            loadSavedResults();
            const modeRadios = document.querySelectorAll('input[name="analysisMode"]');
            modeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateModeCards();
                });
            });
            
            // Click on card to select
            document.getElementById('singleModeCard').addEventListener('click', function() {
                document.querySelector('input[value="single"]').checked = true;
                updateModeCards();
            });
            
            document.getElementById('swarmModeCard').addEventListener('click', function() {
                document.querySelector('input[value="swarm"]').checked = true;
                updateModeCards();
            });
            
            document.getElementById('batchModeCard').addEventListener('click', function() {
                document.querySelector('input[value="batch"]').checked = true;
                updateModeCards();
            });
        });
        
        let batchStrategies = [];
        
        function showAddStrategyModal() {
            document.getElementById('addStrategyModal').style.display = 'block';
            document.getElementById('newStrategyText').value = '';
            document.getElementById('newStrategyText').focus();
        }
        
        function closeAddStrategyModal() {
            document.getElementById('addStrategyModal').style.display = 'none';
        }
        
        function addStrategyToBatch() {
            const strategyText = document.getElementById('newStrategyText').value.trim();
            
            if (!strategyText) {
                alert('Please enter a strategy description');
                return;
            }
            
            batchStrategies.push({
                id: Date.now(),
                text: strategyText
            });
            
            updateBatchStrategiesList();
            closeAddStrategyModal();
        }
        
        function removeBatchStrategy(id) {
            batchStrategies = batchStrategies.filter(s => s.id !== id);
            updateBatchStrategiesList();
        }
        
        function updateBatchStrategiesList() {
            const listDiv = document.getElementById('batchStrategiesList');
            
            if (batchStrategies.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">No strategies added yet. Click "Add Strategy" to begin.</div>';
                return;
            }
            
            let html = '';
            batchStrategies.forEach((strategy, index) => {
                const preview = strategy.text.length > 80 ? strategy.text.substring(0, 80) + '...' : strategy.text;
                html += `
                    <div style="background: #2d2d3d; padding: 12px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="color: #6b7280; font-size: 11px; margin-bottom: 4px;">Strategy ${index + 1}</div>
                            <div style="color: #fff; font-size: 13px;">${preview}</div>
                        </div>
                        <button onclick="removeBatchStrategy(${strategy.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 8px; margin-left: 12px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }
        
        function removeBatchFile(index) {
            batchFiles.splice(index, 1);
            updateBatchFileList();
        }
        
        function updateModeCards() {
            const mode = document.querySelector('input[name="analysisMode"]:checked').value;
            const singleCard = document.getElementById('singleModeCard');
            const swarmCard = document.getElementById('swarmModeCard');
            const batchCard = document.getElementById('batchModeCard');
            const batchSection = document.getElementById('batchUploadSection');
            const strategyInput = document.getElementById('strategyInput');
            
            // Reset all cards
            singleCard.style.background = '#1a1a24';
            singleCard.style.borderColor = '#2d2d3d';
            swarmCard.style.background = '#1a1a24';
            swarmCard.style.borderColor = '#2d2d3d';
            batchCard.style.background = '#1a1a24';
            batchCard.style.borderColor = '#2d2d3d';
            
            if (mode === 'single') {
                singleCard.style.background = '#6366f1';
                singleCard.style.borderColor = '#6366f1';
                batchSection.style.display = 'none';
                strategyInput.style.display = 'block';
            } else if (mode === 'swarm') {
                swarmCard.style.background = '#6366f1';
                swarmCard.style.borderColor = '#6366f1';
                batchSection.style.display = 'none';
                strategyInput.style.display = 'block';
            } else if (mode === 'batch') {
                batchCard.style.background = '#6366f1';
                batchCard.style.borderColor = '#6366f1';
                batchSection.style.display = 'block';
                strategyInput.style.display = 'none';
            }
        }
        
        async function submitStrategies() {
            let ideas = document.getElementById('strategyIdeas').value.trim();
            
            // If empty, use default prompt
            if (!ideas) {
                ideas = 'RSI divergence with MACD confirmation on SPY (swing trade)';
                document.getElementById('strategyIdeas').value = ideas;
            }
            
            // Get RBI agent version and model
            const rbiAgentVersion = document.getElementById('rbiAgentVersion').value;
            const aiModel = document.getElementById('aiModel').value;
            
            // Get RL flag
            const enableRL = document.getElementById('enableRL').checked;
            
            // Get analysis mode
            const mode = document.querySelector('input[name="analysisMode"]:checked').value;
            const model = mode === 'single' ? document.getElementById('singleAgentModel').value : null;
            
            // Parse strategies (one per line, ignore empty lines)
            const strategyList = ideas.split('\n')
                .map(s => s.trim())
                .filter(s => s && !s.startsWith('#'));
            
            if (strategyList.length === 0) {
                alert('‚ùå Please enter at least one valid strategy idea');
                return;
            }
            
            // Show processing section
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            
            // Disable submit button
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // CRITICAL: Append to strategies array instead of replacing
            const newStrategies = strategyList.map((idea, index) => ({
                id: Date.now() + index,
                idea: idea,
                status: 'queued',
                research: null,
                backtest: null,
                results: null,
                mode: mode,
                model: model,
                rbiAgentVersion: rbiAgentVersion,
                aiModel: aiModel,
                enableRL: enableRL,
                rlStatus: enableRL ? 'training' : null,
                rlTrainingCount: 0
            }));
            
            // Add new strategies to existing array
            strategies.push(...newStrategies);
            
            // Save immediately
            saveResults();
            
            updateProcessingQueue();
            updateResultsTable();
            
            // Process only NEW strategies (not already completed/failed)
            const startIndex = strategies.length - newStrategies.length;
            for (let i = startIndex; i < strategies.length; i++) {
                // Skip if already processed
                if (strategies[i].status === 'completed' || strategies[i].status === 'failed') {
                    continue;
                }
                await processStrategy(i);
            }
            
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> Research & Backtest Strategies';
        }
        
        async function processStrategy(index) {
            const strategy = strategies[index];
            
            // Update status: researching
            strategy.status = 'researching';
            updateProcessingQueue();
            updateResultsTable();
            
            try {
                if (strategy.mode === 'swarm') {
                    // Use swarm mode
                    const swarmRes = await fetch('/api/swarm/analyze', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({prompt: `Analyze this trading strategy: ${strategy.idea}`})
                    });
                    const swarmData = await swarmRes.json();
                    strategy.swarm_consensus = swarmData.consensus;
                    strategy.models_count = swarmData.models_count;
                }
                
                // Call RBI research API with agent version and model
                const response = await fetch('/api/rbi/submit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        trading_idea: strategy.idea,
                        model: strategy.model,
                        rbi_agent_version: strategy.rbiAgentVersion,
                        ai_model: strategy.aiModel
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    strategy.research = result.result;
                    strategy.status = 'backtesting';
                    updateProcessingQueue();
                    updateResultsTable();
                    
                    // Extract strategy name from research result
                    const strategyName = result.result.strategy_name || strategy.idea.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '');
                    
                    // Run REAL backtest
                    try {
                        const backtestResponse = await fetch('/api/rbi/backtest', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                strategy_name: strategyName,
                                enable_rbi_rl: strategy.enableRL
                            })
                        });
                        
                        const backtestResult = await backtestResponse.json();
                        
                        if (backtestResult.status === 'success') {
                            // Use REAL backtest results
                            const results = backtestResult.results;
                            
                            // Extract ticker from strategy idea (default to SPY)
                            const tickerMatch = strategy.idea.match(/\b(SPY|QQQ|AAPL|TSLA|BTC|ETH|SOL)\b/i);
                            const ticker = tickerMatch ? tickerMatch[0].toUpperCase() : 'SPY';
                            
                            // Determine timeframe (default to 1D)
                            const timeframeMatch = strategy.idea.match(/\b(1m|5m|15m|1h|4h|1d|1w)\b/i);
                            const timeframe = timeframeMatch ? timeframeMatch[0].toUpperCase() : '1D';
                            
                            strategy.results = {
                                ticker: ticker,
                                timeframe: timeframe,
                                total_return: results.total_return || 0,
                                buy_hold_return: results.buy_hold_return || 0,
                                win_rate: results.win_rate || 50,
                                sharpe_ratio: results.sharpe_ratio || 0,
                                max_drawdown: results.max_drawdown || 0,
                                total_trades: results.total_trades || 0,
                                risk_grade: results.risk_grade || 'C',
                                start_date: '2023-01-01',
                                end_date: '2024-12-31'
                            };
                            
                            // Handle RL status if returned
                            if (backtestResult.rl_status) {
                                strategy.rlStatus = backtestResult.rl_status.status;
                                strategy.rlTrainingCount = backtestResult.rl_status.progress || 0;
                            }
                            
                            // Check for underperformance
                            const totalReturn = parseFloat(results.total_return) || 0;
                            const buyHoldReturn = parseFloat(results.buy_hold_return) || 0;
                            const winRate = parseFloat(results.win_rate) || 0;
                            
                            // Warning removed per user request
                            
                            strategy.status = 'completed';
                        } else {
                            // Backtest failed - show error
                            strategy.status = 'failed';
                            strategy.error = backtestResult.message || 'Backtest execution failed';
                        }
                    } catch (backtestError) {
                        // Backtest API call failed
                        strategy.status = 'failed';
                        strategy.error = `Backtest error: ${backtestError.message}`;
                    }
                } else {
                    strategy.status = 'failed';
                    strategy.error = result.message;
                }
                
            } catch (error) {
                strategy.status = 'failed';
                strategy.error = error.message;
            }
            
            // CRITICAL: Save to localStorage after each update
            saveResults();
            updateProcessingQueue();
            updateResultsTable();
        }
        
        function updateProcessingQueue() {
            const queueDiv = document.getElementById('processingQueue');
            
            // Only show strategies that are in progress (queued, researching, backtesting)
            const inProgressStrategies = strategies.filter(s => 
                s.status === 'queued' || s.status === 'researching' || s.status === 'backtesting'
            );
            
            const queueHTML = inProgressStrategies.map(s => {
                let icon, color, statusText;
                
                switch(s.status) {
                    case 'queued':
                        icon = 'clock';
                        color = '#6b7280';
                        statusText = 'Queued';
                        break;
                    case 'researching':
                        icon = 'spinner fa-spin';
                        color = '#6366f1';
                        statusText = 'Researching...';
                        break;
                    case 'backtesting':
                        icon = 'spinner fa-spin';
                        color = '#8b5cf6';
                        statusText = 'Backtesting...';
                        break;
                    case 'completed':
                        icon = 'check-circle';
                        color = '#22c55e';
                        statusText = 'Completed';
                        break;
                    case 'failed':
                        icon = 'times-circle';
                        color = '#ef4444';
                        statusText = 'Failed';
                        break;
                }
                
                return `
                    <div style="display: flex; align-items: center; padding: 12px; background: #1a1a24; border-radius: 6px; margin-bottom: 8px;">
                        <i class="fas fa-${icon}" style="margin-right: 12px; color: ${color};"></i>
                        <span style="flex: 1; color: #d1d5db;">${s.idea.substring(0, 80)}${s.idea.length > 80 ? '...' : ''}</span>
                        <span style="color: ${color}; font-weight: 600; font-size: 13px;">${statusText}</span>
                    </div>
                `;
            }).join('');
            
            queueDiv.innerHTML = queueHTML;
        }
        
        function updateResultsTable() {
            const tbody = document.getElementById('resultsBody');
            
            // Save to localStorage whenever table is updated
            saveResults();
            
            const rowsHTML = strategies.map(s => {
                if (s.status === 'queued' || s.status === 'researching' || s.status === 'backtesting') {
                    return `
                        <tr style="border-bottom: 1px solid #1f1f2e;">
                            <td style="padding: 12px; color: #d1d5db; font-size: 13px;">${s.idea.substring(0, 50)}${s.idea.length > 50 ? '...' : ''}</td>
                            <td colspan="12" style="padding: 12px; text-align: center; color: #6b7280; font-size: 13px;">
                                <i class="fas fa-spinner fa-spin"></i> Processing...
                            </td>
                        </tr>
                    `;
                }
                
                if (s.status === 'failed') {
                    return `
                        <tr style="border-bottom: 1px solid #1f1f2e;">
                            <td colspan="11" style="padding: 12px; text-align: left; color: #ef4444; font-size: 13px;">
                                <i class="fas fa-times-circle"></i> Failed: ${s.error || 'Unknown error'}
                                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">${s.idea.substring(0, 80)}${s.idea.length > 80 ? '...' : ''}</div>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="deleteStrategy(${s.id})" style="background: #ef4444; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                if (s.status === 'completed' && s.results) {
                    const returnColor = parseFloat(s.results.total_return) >= 0 ? '#22c55e' : '#ef4444';
                    const returnIcon = parseFloat(s.results.total_return) >= 0 ? 'arrow-up' : 'arrow-down';
                    const buyHoldColor = parseFloat(s.results.buy_hold_return) >= 0 ? '#22c55e' : '#ef4444';
                    const buyHoldIcon = parseFloat(s.results.buy_hold_return) >= 0 ? 'arrow-up' : 'arrow-down';
                    
                    // Risk grade colors
                    const gradeColors = {
                        'A': '#22c55e',
                        'B': '#84cc16',
                        'C': '#eab308',
                        'D': '#f97316',
                        'F': '#ef4444'
                    };
                    
                    // Mode badge
                    const modeBadge = s.mode === 'swarm' 
                        ? '<span style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">üêù SWARM</span>'
                        : `<span style="background: rgba(99, 102, 241, 0.15); color: #6366f1; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">‚ö° ${s.model || 'SINGLE'}</span>`;
                    
                    // RL badge
                    let rlBadge = '';
                    if (s.enableRL) {
                        if (s.rlStatus === 'training') {
                            rlBadge = `<span style="background: #f59e0b; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; margin-left: 6px;">üîÑ Training (${s.rlTrainingCount || 0}/10)</span>`;
                        } else if (s.rlStatus === 'optimized') {
                            rlBadge = `<span style="background: #10b981; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; margin-left: 6px;">‚ú® RL Optimized</span>`;
                        }
                    }
                    
                    // Calculate period
                    const period = s.results.period || '1 year';
                    
                    // Warning badge for underperformance
                    const warningBadge = s.warning ? `<div style="color: #f59e0b; font-size: 11px; margin-top: 4px;"><i class="fas fa-exclamation-triangle"></i> ${s.warning}</div>` : '';
                    
                    return `
                        <tr style="border-bottom: 1px solid #1f1f2e;">
                            <td style="padding: 12px; color: #d1d5db; max-width: 300px; font-size: 13px;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${s.idea.substring(0, 60)}${s.idea.length > 60 ? '...' : ''}${rlBadge}</div>
                                ${warningBadge}
                            </td>
                            <td style="padding: 12px; text-align: center; color: #d1d5db; font-weight: 600; font-size: 13px;">${s.results.ticker}</td>
                            <td style="padding: 12px; text-align: center; color: #9ca3af; font-size: 13px;">${s.results.timeframe}</td>
                            <td style="padding: 12px; text-align: center; color: #9ca3af; font-size: 13px;">${period}</td>
                            <td style="padding: 12px; text-align: center;">
                                ${modeBadge}
                            </td>
                            <td style="padding: 12px; text-align: center; color: ${returnColor}; font-weight: 600; font-size: 13px;">
                                <i class="fas fa-${returnIcon}"></i> ${parseFloat(s.results.total_return).toFixed(2)}%
                            </td>
                            <td style="padding: 12px; text-align: center; color: ${buyHoldColor}; font-size: 13px;">
                                <i class="fas fa-${buyHoldIcon}"></i> ${parseFloat(s.results.buy_hold_return).toFixed(2)}%
                            </td>
                            <td style="padding: 12px; text-align: center; color: #d1d5db; font-size: 13px;">${parseFloat(s.results.win_rate).toFixed(2)}%</td>
                            <td style="padding: 12px; text-align: center; color: #d1d5db; font-size: 13px;">${parseFloat(s.results.sharpe_ratio).toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center; color: #ef4444; font-size: 13px;">-${parseFloat(s.results.max_drawdown).toFixed(2)}%</td>
                            <td style="padding: 12px; text-align: center;">
                                <div style="display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: ${gradeColors[s.results.risk_grade]}; color: #fff; font-weight: 700; font-size: 14px;" title="Risk Rating: A=Excellent, B=Good, C=Average, D=Poor, F=High Risk">
                                    ${s.results.risk_grade}
                                </div>
                            </td>
                            <td style="padding: 12px; text-align: center; color: #d1d5db; font-size: 13px;">${s.results.total_trades}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="viewDetails(${s.id})" style="background: #6366f1; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin-right: 4px;">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button onclick="downloadBacktestData(${s.id})" style="background: #10b981; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin-right: 4px;">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button onclick="deleteStrategy(${s.id})" style="background: #ef4444; color: #fff; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
                return '';
            }).join('');
            
            tbody.innerHTML = rowsHTML;
        }
        
        function viewDetails(strategyId) {
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy) return;
            
            const detailsHTML = `
                <h2 style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 12px;">
                    ${strategy.idea}
                </h2>
                <div style="color: #9ca3af; font-size: 14px; margin-bottom: 24px;">
                    ${strategy.results.ticker} ‚Ä¢ ${strategy.results.timeframe} ‚Ä¢ ${strategy.results.start_date} to ${strategy.results.end_date}
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div style="background: #1a1a24; padding: 20px; border-radius: 8px;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Total Return</div>
                        <div style="color: ${parseFloat(strategy.results.total_return) >= 0 ? '#22c55e' : '#ef4444'}; font-size: 28px; font-weight: 700;">
                            ${parseFloat(strategy.results.total_return).toFixed(2)}%
                        </div>
                    </div>
                    <div style="background: #1a1a24; padding: 20px; border-radius: 8px;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Buy & Hold</div>
                        <div style="color: ${parseFloat(strategy.results.buy_hold_return) >= 0 ? '#22c55e' : '#ef4444'}; font-size: 28px; font-weight: 700;">
                            ${parseFloat(strategy.results.buy_hold_return).toFixed(2)}%
                        </div>
                    </div>
                    <div style="background: #1a1a24; padding: 20px; border-radius: 8px;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Win Rate</div>
                        <div style="color: #fff; font-size: 28px; font-weight: 700;">${parseFloat(strategy.results.win_rate).toFixed(2)}%</div>
                    </div>
                    <div style="background: #1a1a24; padding: 20px; border-radius: 8px;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Sharpe Ratio</div>
                        <div style="color: #fff; font-size: 28px; font-weight: 700;">${parseFloat(strategy.results.sharpe_ratio).toFixed(2)}</div>
                    </div>
                    <div style="background: #1a1a24; padding: 20px; border-radius: 8px;">
                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Max Drawdown</div>
                        <div style="color: #ef4444; font-size: 28px; font-weight: 700;">-${parseFloat(strategy.results.max_drawdown).toFixed(2)}%</div>
                    </div>
                </div>
                
                <div style="background: #1a1a24; padding: 24px; border-radius: 8px; margin-bottom: 24px;">
                    <h3 style="color: #fff; font-size: 18px; margin-bottom: 16px;">
                        <i class="fas fa-brain"></i> AI Research Summary
                    </h3>
                    <div style="color: #d1d5db; line-height: 1.8; white-space: pre-wrap;">
                        ${strategy.research?.strategy_writeup || strategy.research?.writeup || (typeof strategy.research === 'string' ? strategy.research : 'No research available')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button onclick="deployStrategy(${strategy.id})" style="flex: 1; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #fff; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-rocket"></i> Deploy to Live Trading
                    </button>
                    <button onclick="downloadCode(${strategy.id})" style="flex: 1; background: #1a1a24; color: #fff; border: 1px solid #2d2d3d; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-download"></i> Download Backtest Code
                    </button>
                </div>
            `;
            
            document.getElementById('detailsContent').innerHTML = detailsHTML;
            document.getElementById('detailsModal').style.display = 'block';
        }
        
        function closeDetails() {
            document.getElementById('detailsModal').style.display = 'none';
        }
        
        async function deployStrategy(strategyId) {
            // Find strategy in strategies array (not backtestResults)
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy) {
                alert('‚ùå Strategy not found');
                return;
            }
            
            // Extract ticker from strategy idea (look for common patterns)
            let ticker = 'BTC';  // default
            const ideaUpper = strategy.idea.toUpperCase();
            const cryptoTickers = ['BTC', 'ETH', 'SOL', 'DOGE', 'ADA', 'DOT', 'LINK', 'UNI', 'AVAX', 'MATIC'];
            const stockTickers = ['SPY', 'QQQ', 'AAPL', 'TSLA', 'NVDA', 'MSFT', 'GOOGL', 'AMZN', 'META', 'AMD'];
            
            for (const t of [...cryptoTickers, ...stockTickers]) {
                if (ideaUpper.includes(t)) {
                    ticker = t;
                    break;
                }
            }
            
            // Extract timeframe (look for patterns like "1H", "4H", "Daily", "1D")
            let timeframe = '1D';  // default
            if (ideaUpper.includes('15M') || ideaUpper.includes('15 MIN')) timeframe = '15m';
            else if (ideaUpper.includes('1H') || ideaUpper.includes('HOUR')) timeframe = '1H';
            else if (ideaUpper.includes('4H')) timeframe = '4H';
            else if (ideaUpper.includes('DAILY') || ideaUpper.includes('1D')) timeframe = '1D';
            else if (ideaUpper.includes('WEEK') || ideaUpper.includes('1W')) timeframe = '1W';
            
            // Get strategy name from research result
            const strategyName = strategy.research?.strategy_name || strategy.idea.substring(0, 30).replace(/[^a-zA-Z0-9]/g, '');
            
            // Find backtest file path
            const today = new Date();
            const dateStr = `${String(today.getMonth() + 1).padStart(2, '0')}_${String(today.getDate()).padStart(2, '0')}_${today.getFullYear()}`;
            const backtestFile = `C:\\Users\\ahmed\\CascadeProjects\\moon-dev-ai-agents\\src\\data\\rbi\\${dateStr}\\backtests_final\\${strategyName}_BTFinal.py`;
            
            if (!confirm(`Deploy "${strategyName}" to Live Trading?\n\nTicker: ${ticker}\nTimeframe: ${timeframe}\nStrategy: ${strategy.idea}\n\nThis will create a new trading agent.`)) {
                return;
            }
            
            try {
                // Use new RBI deployment pipeline
                const response = await fetch('/api/rbi/deploy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        strategy_name: strategyName,
                        backtest_file: backtestFile,
                        backtest_results: {
                            sharpe_ratio: strategy.results?.sharpe_ratio || 2.0,
                            total_return: strategy.results?.total_return || 25.0,
                            total_trades: strategy.results?.total_trades || 100,
                            max_drawdown: Math.abs(strategy.results?.max_drawdown || -5.0),
                            win_rate: strategy.results?.win_rate || 55.0
                        },
                        config: {
                            ticker: ticker,
                            timeframe: timeframe,
                            asset_type: cryptoTickers.includes(ticker) ? 'crypto' : 'stock',
                            initial_balance: 100000,
                            system_prompt: strategy.idea  // Use trading idea as system prompt
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`‚úÖ Strategy deployed to RBI Pipeline!\n\nDeployment ID: ${result.deployment_id}\nAgent ID: ${result.agent_id}\nStatus: ${result.deployment_status}\n\n${result.deployment_status === 'paper_trading' ? 'Agent will run in paper trading for 14 days before auto-promotion to live.' : 'Agent is ready to start!'}\n\nGo to LIVE TRADING page to activate and monitor it.`);
                    // Redirect to live trading page
                    window.location.href = '/';
                } else {
                    alert(`‚ùå Deployment failed: ${result.message}`);
                }
            } catch (error) {
                console.error('Deployment error:', error);
                alert('‚ùå Error deploying strategy. Check console for details.');
            }
        }
        
        function downloadCode(strategyId) {
            alert('üì• Code download feature coming soon!\n\nThis will provide the complete Python backtest code for your strategy.');
        }
        
        function downloadBacktestData(strategyId) {
            const strategy = strategies.find(s => s.id === strategyId);
            if (!strategy || !strategy.results) {
                alert('‚ùå No backtest data available for this strategy');
                return;
            }
            
            // Create comprehensive backtest data object
            const backtestData = {
                strategy_name: strategy.idea,
                ticker: strategy.results.ticker,
                timeframe: strategy.results.timeframe,
                period: `${strategy.results.start_date} to ${strategy.results.end_date}`,
                mode: strategy.mode,
                model: strategy.model,
                performance_metrics: {
                    total_return: strategy.results.total_return + '%',
                    buy_hold_return: strategy.results.buy_hold_return + '%',
                    win_rate: strategy.results.win_rate + '%',
                    sharpe_ratio: strategy.results.sharpe_ratio,
                    max_drawdown: strategy.results.max_drawdown + '%',
                    risk_grade: strategy.results.risk_grade,
                    total_trades: strategy.results.total_trades
                },
                research_summary: strategy.research || 'N/A',
                swarm_consensus: strategy.swarm_consensus || null,
                models_count: strategy.models_count || null,
                generated_at: new Date().toISOString()
            };
            
            // Convert to JSON and download
            const dataStr = JSON.stringify(backtestData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backtest_${strategy.results.ticker}_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            console.log('‚úÖ Backtest data downloaded successfully');
        }
        
        function deleteStrategy(strategyId) {
            if (!confirm('Are you sure you want to delete this strategy? This action cannot be undone.')) {
                return;
            }
            
            // Remove from strategies array
            strategies = strategies.filter(s => s.id !== strategyId);
            
            // Save updated list
            saveResults();
            
            // Update UI
            updateResultsTable();
            
            // Hide results section if no strategies left
            if (strategies.length === 0) {
                document.getElementById('resultsSection').style.display = 'none';
            }
            
            console.log('‚úÖ Strategy deleted successfully');
        }
        
    </script>
</body>
</html>
