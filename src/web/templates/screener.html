<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Market Screener - Moon Dev</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-style.css') }}?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="nav-links">
                <a href="/">LIVE TRADING</a>
                <a href="/screener" class="active">SCREENER</a>
                <a href="/analyst">ANALYST</a>
                <a href="/portfolio">PORTFOLIO</a>
                <a href="/strategy-lab">STRATEGY LAB</a>
            </div>
        </div>
    </nav>

    <div class="container">


        <!-- Filter Tabs -->
        <div class="filter-tabs" style="margin-bottom: 24px;">
            <button class="filter-tab active" onclick="filterOpportunities('day')" data-type="day">
                <i class="fas fa-bolt"></i> Day Trade
            </button>
            <button class="filter-tab" onclick="filterOpportunities('swing')" data-type="swing">
                <i class="fas fa-chart-line"></i> Swing Trade
            </button>
            <button class="filter-tab" onclick="filterOpportunities('investment')" data-type="investment">
                <i class="fas fa-seedling"></i> Investment
            </button>
        </div>

        <!-- Opportunities Grid -->
        <div id="opportunities-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
            <!-- Populated via JS -->
        </div>
    </div>

    <!-- Rationale Modal -->
    <div id="rationale-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div style="font-size: 20px; font-weight: 700; color: #fff;">
                    <i class="fas fa-brain"></i> Trade Rationale: <span id="rationale-symbol"></span>
                </div>
                <button style="background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer;" onclick="closeRationaleModal()">√ó</button>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <span id="rationale-badge"></span>
                    <span style="margin-left: 12px; color: #9ca3af;">Confidence: <span id="rationale-confidence" style="color: #fff; font-weight: 600;"></span></span>
                </div>
                <div style="background: #1a1a24; padding: 16px; border-radius: 8px; border-left: 3px solid #6366f1;">
                    <div style="color: #9ca3af; font-size: 12px; font-weight: 600; margin-bottom: 12px;">WHY THIS IS A GOOD TRADE:</div>
                    <p id="rationale-text" style="color: #e5e7eb; line-height: 1.8; font-size: 14px;"></p>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 6px;">
                    <div style="color: #6366f1; font-size: 12px; font-weight: 600; margin-bottom: 4px;">
                        <i class="fas fa-lightbulb"></i> KEY FACTORS
                    </div>
                    <ul id="rationale-factors" style="color: #9ca3af; font-size: 13px; margin: 0; padding-left: 20px;">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Selector Modal -->
    <div id="agent-selector-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div style="font-size: 20px; font-weight: 700; color: #fff;">Select Agent</div>
                <button style="background: none; border: none; color: #9ca3af; font-size: 24px; cursor: pointer;" onclick="closeAgentSelector()">√ó</button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #9ca3af; margin-bottom: 16px;">Choose which agent to deploy this opportunity to:</p>
                <div id="agent-list">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'day';
        let selectedSymbol = null;
        let customTickers = [];

        // Initialize
        $(document).ready(function() {
            loadCustomTickers();
            loadOpportunities();
            setInterval(() => {
                // Reload custom tickers from localStorage before fetching opportunities
                loadCustomTickers();
                loadOpportunities(currentFilter);
            }, 60000); // Refresh every minute
        });

        // Load custom tickers from localStorage
        function loadCustomTickers() {
            const saved = localStorage.getItem('customTickers');
            if (saved) {
                customTickers = JSON.parse(saved);
                renderCustomTickers();
            }
        }

        // Save custom tickers to localStorage
        function saveCustomTickers() {
            localStorage.setItem('customTickers', JSON.stringify(customTickers));
        }

        // Toggle custom ticker panel
        function toggleCustomTickerPanel() {
            const panel = document.getElementById('custom-ticker-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // Add custom tickers
        function addCustomTickers() {
            const input = document.getElementById('custom-tickers-input');
            const value = input.value.trim().toUpperCase();
            
            if (!value) return;
            
            // Parse comma-separated tickers
            const newTickers = value.split(',').map(t => t.trim()).filter(t => t.length > 0);
            
            // Add to list (avoid duplicates)
            newTickers.forEach(ticker => {
                if (!customTickers.includes(ticker)) {
                    customTickers.push(ticker);
                }
            });
            
            // Save and render
            saveCustomTickers();
            renderCustomTickers();
            
            // Clear input
            input.value = '';
            
            // Reload opportunities
            loadOpportunities(currentFilter);
            
            // Close panel after adding
            document.getElementById('custom-ticker-panel').style.display = 'none';
        }

        // Remove custom ticker
        function removeCustomTicker(ticker) {
            customTickers = customTickers.filter(t => t !== ticker);
            saveCustomTickers();
            renderCustomTickers();
            loadOpportunities(currentFilter);
        }

        // Render custom tickers as badges
        function renderCustomTickers() {
            const container = document.getElementById('custom-tickers-list');
            
            if (customTickers.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; font-size: 12px;">No custom tickers added yet</div>';
                return;
            }
            
            container.innerHTML = customTickers.map(ticker => `
                <span style="background: #6366f1; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                    ${ticker}
                    <button onclick="removeCustomTicker('${ticker}')" style="background: none; border: none; color: #fff; cursor: pointer; padding: 0; font-size: 14px;">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }

        // Load opportunities
        async function loadOpportunities(type = 'all') {
            try {
                // Build URL with custom tickers
                let url = `/api/screener/opportunities?type=${type}`;
                if (customTickers.length > 0) {
                    url += `&custom_tickers=${customTickers.join(',')}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Check if response is an error object
                if (data.error) {
                    console.error('API Error:', data.error);
                    document.getElementById('opportunities-grid').innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <div style="font-size: 18px; font-weight: 600;">Error Loading Opportunities</div>
                            <div style="font-size: 14px; margin-top: 8px; color: #9ca3af;">${data.error}</div>
                        </div>
                    `;
                    return;
                }
                
                // Ensure data is an array
                const opportunities = Array.isArray(data) ? data : [];
                displayOpportunities(opportunities);
            } catch (e) {
                console.error('Error loading opportunities:', e);
                document.getElementById('opportunities-grid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <div style="font-size: 18px; font-weight: 600;">Error Loading Opportunities</div>
                        <div style="font-size: 14px; margin-top: 8px; color: #9ca3af;">Please try again later</div>
                    </div>
                `;
            }
        }

        // Display opportunities
        function displayOpportunities(opportunities) {
            const grid = document.getElementById('opportunities-grid');
            
            if (opportunities.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #6b7280;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <div style="font-size: 18px; font-weight: 600;">No Opportunities Found</div>
                        <div style="font-size: 14px; margin-top: 8px;">Try a different filter or check back later</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = opportunities.map(opp => {
                // DEBUG: Log trade_type
                console.log(`${opp.symbol}: trade_type = ${opp.trade_type}`);
                
                const changeClass = opp.change >= 0 ? 'positive' : 'negative';
                const changeSign = opp.change >= 0 ? '+' : '';
                const sentimentColor = opp.sentiment.class === 'positive' ? '#22c55e' : opp.sentiment.class === 'negative' ? '#ef4444' : '#eab308';
                
                // Trade type badge with icon in colored circle
                const tradeTypeBadge = opp.trade_type === 'day' ? 
                    '<span style="display: inline-flex; align-items: center; gap: 6px; background: rgba(99, 102, 241, 0.15); color: #6366f1; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;"><span style="display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #6366f1; border-radius: 50%;"><i class="fas fa-bolt" style="font-size: 10px; color: #fff;"></i></span>DAY TRADE</span>' :
                    opp.trade_type === 'swing' ?
                    '<span style="display: inline-flex; align-items: center; gap: 6px; background: rgba(139, 92, 246, 0.15); color: #8b5cf6; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;"><span style="display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #8b5cf6; border-radius: 50%;"><i class="fas fa-chart-line" style="font-size: 10px; color: #fff;"></i></span>SWING TRADE</span>' :
                    '<span style="display: inline-flex; align-items: center; gap: 6px; background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; letter-spacing: 0.5px;"><span style="display: flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: #22c55e; border-radius: 50%;"><i class="fas fa-seedling" style="font-size: 10px; color: #fff;"></i></span>INVESTMENT</span>';
                
                // Build additional info sections
                let additionalInfo = '';
                
                // Add fundamentals for investment category
                if (opp.trade_type === 'investment' && opp.fundamentals) {
                    additionalInfo += `
                        <div style="background: #1a1a24; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #9ca3af; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-building"></i> FUNDAMENTALS
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div><span style="color: #9ca3af;">P/E:</span> <span style="color: #fff;">${opp.fundamentals.pe_ratio}</span></div>
                                <div><span style="color: #9ca3af;">Sector:</span> <span style="color: #fff;">${opp.fundamentals.sector}</span></div>
                                <div style="grid-column: 1/-1;"><span style="color: #9ca3af;">Rating:</span> <span style="color: #22c55e; font-weight: 600;">${opp.fundamentals.investment_rating}</span> (${opp.fundamentals.investment_score}/100)</div>
                            </div>
                        </div>
                    `;
                }
                
                // Add advanced technicals
                if (opp.technicals) {
                    additionalInfo += `
                        <div style="background: #1a1a24; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #9ca3af; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-chart-area"></i> ADVANCED TECHNICALS
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                                <div><span style="color: #9ca3af;">ROC:</span> <span style="color: ${opp.technicals.roc > 0 ? '#22c55e' : '#ef4444'};">${opp.technicals.roc}%</span></div>
                                <div><span style="color: #9ca3af;">Stoch:</span> <span style="color: #fff;">${opp.technicals.stochastic}</span></div>
                                <div><span style="color: #9ca3af;">ADX:</span> <span style="color: #fff;">${opp.technicals.adx}</span></div>
                                <div><span style="color: #9ca3af;">OBV:</span> <span style="color: ${opp.technicals.obv_trend === 'up' ? '#22c55e' : '#ef4444'};">${opp.technicals.obv_trend}</span></div>
                            </div>
                        </div>
                    `;
                }
                
                // Add news sentiment
                if (opp.news && opp.news.articles > 0) {
                    additionalInfo += `
                        <div style="background: #1a1a24; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                            <div style="color: #9ca3af; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-newspaper"></i> NEWS SENTIMENT
                            </div>
                            <div style="font-size: 12px;">
                                <span style="color: #9ca3af;">${opp.news.articles} articles:</span> 
                                <span style="color: ${opp.news.score > 0 ? '#22c55e' : opp.news.score < 0 ? '#ef4444' : '#eab308'}; font-weight: 600;">
                                    ${opp.news.sentiment}
                                </span>
                            </div>
                        </div>
                    `;
                }
                
                // Add chart analysis if available
                if (opp.chart_analysis) {
                    const chartSignalColor = opp.chart_analysis.signal === 'BUY' ? '#22c55e' : 
                                            opp.chart_analysis.signal === 'SELL' ? '#ef4444' : '#eab308';
                    additionalInfo += `
                        <div style="background: #1a1a24; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid ${chartSignalColor};">
                            <div style="color: #9ca3af; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
                                <i class="fas fa-chart-candlestick"></i> CHART ANALYSIS
                            </div>
                            <div style="font-size: 12px; margin-bottom: 6px;">
                                <span style="color: ${chartSignalColor}; font-weight: 700; font-size: 14px;">${opp.chart_analysis.signal}</span>
                                <span style="color: #9ca3af; margin-left: 8px;">${opp.chart_analysis.confidence}% confidence</span>
                            </div>
                            <div style="color: #e5e7eb; font-size: 11px; line-height: 1.5;">${opp.chart_analysis.reasoning}</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="opportunity-card">
                        <div class="opp-header">
                            <div>
                                <h3 style="font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px;">${opp.symbol}</h3>
                                ${tradeTypeBadge}
                            </div>
                            <div style="text-align: right;">
                                <div class="opp-price" style="font-size: 20px; font-weight: 600; color: #fff;">$${opp.price.toFixed(2)}</div>
                                <span class="change ${changeClass}" style="font-size: 14px; font-weight: 600;">
                                    ${changeSign}${opp.change.toFixed(2)}%
                                </span>
                            </div>
                        </div>
                        
                        <div class="opp-sentiment" style="margin: 16px 0; padding: 12px; background: rgba(${sentimentColor === '#22c55e' ? '34, 197, 94' : sentimentColor === '#ef4444' ? '239, 68, 68' : '234, 179, 8'}, 0.1); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #9ca3af; font-size: 12px; font-weight: 600;">SENTIMENT</span>
                                <span style="color: ${sentimentColor}; font-weight: 600;">${opp.sentiment.label}</span>
                            </div>
                        </div>
                        
                        <div class="opp-reasoning" style="margin-bottom: 16px;">
                            <div style="color: #9ca3af; font-size: 12px; font-weight: 600; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-brain"></i> AI ANALYSIS</span>
                                ${additionalInfo ? `<button onclick="toggleDetails('${opp.symbol}-${opp.trade_type}')" class="btn-icon" title="Show details" style="background: none; border: none; color: #6366f1; cursor: pointer; padding: 4px 8px;"><i class="fas fa-info-circle"></i></button>` : ''}
                            </div>
                            <p style="color: #e5e7eb; font-size: 13px; line-height: 1.6;">${opp.ai_reasoning}</p>
                        </div>
                        
                        <div id="details-${opp.symbol}-${opp.trade_type}" style="display: none;">
                            ${additionalInfo}
                        </div>
                        
                        <div class="opp-levels" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div style="background: #1a1a24; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">ENTRY</div>
                                <div style="color: #fff; font-weight: 600;">$${opp.entry_price.toFixed(2)}</div>
                            </div>
                            <div style="background: #1a1a24; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">TARGET</div>
                                <div style="color: #22c55e; font-weight: 600;">$${opp.target_price.toFixed(2)}</div>
                            </div>
                            <div style="background: #1a1a24; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">STOP</div>
                                <div style="color: #ef4444; font-weight: 600;">$${opp.stop_loss.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="color: #9ca3af; font-size: 12px;">
                                <i class="fas fa-chart-bar"></i> Confidence: <span style="color: #fff; font-weight: 600;">${opp.confidence}%</span>
                            </div>
                            <div style="flex: 1; height: 6px; background: #1a1a24; border-radius: 3px; margin-left: 12px; overflow: hidden;">
                                <div style="height: 100%; width: ${opp.confidence}%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 3px;"></div>
                            </div>
                        </div>
                        
                        <div class="opp-actions" style="display: flex; gap: 8px;">
                            ${opp.trade_type === 'investment' ? 
                                `<button onclick="addToPortfolio('${opp.symbol}', '${(opp.fundamentals && opp.fundamentals.sector) || 'Unknown'}')" class="btn btn-success" style="flex: 1;">
                                    <i class="fas fa-briefcase"></i> Add to Portfolio
                                </button>` :
                                `<button onclick="deployToAgent('${opp.symbol}')" class="btn btn-primary" style="flex: 1;">
                                    <i class="fas fa-rocket"></i> Deploy to Agent
                                </button>`
                            }
                            <button onclick="showRationale('${opp.symbol}', \`${opp.ai_reasoning}\`, ${opp.confidence}, '${opp.trade_type}')" class="btn btn-secondary" title="View detailed rationale">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter opportunities
        function filterOpportunities(type) {
            currentFilter = type;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.type === type) {
                    tab.classList.add('active');
                }
            });
            
            loadOpportunities(type);
        }

        // Refresh opportunities
        function refreshOpportunities() {
            loadOpportunities(currentFilter);
        }

        // Toggle additional details
        function toggleDetails(id) {
            const detailsDiv = document.getElementById(`details-${id}`);
            if (detailsDiv) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                } else {
                    detailsDiv.style.display = 'none';
                }
            }
        }

        // Show rationale modal
        function showRationale(symbol, reasoning, confidence, tradeType) {
            document.getElementById('rationale-symbol').textContent = symbol;
            document.getElementById('rationale-confidence').textContent = confidence + '%';
            document.getElementById('rationale-text').textContent = reasoning;
            
            // Set badge
            const badge = tradeType === 'day' ? 
                '<span style="background: rgba(99, 102, 241, 0.15); color: #6366f1; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;"><i class="fas fa-bolt"></i> DAY TRADE</span>' :
                tradeType === 'swing' ?
                '<span style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;"><i class="fas fa-chart-line"></i> SWING TRADE</span>' :
                '<span style="background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;"><i class="fas fa-seedling"></i> INVESTMENT</span>';
            document.getElementById('rationale-badge').innerHTML = badge;
            
            // Extract key factors from reasoning
            const factors = reasoning.split('. ').filter(f => f.length > 10);
            document.getElementById('rationale-factors').innerHTML = factors.map(f => 
                `<li style="margin-bottom: 8px;">${f}</li>`
            ).join('');
            
            document.getElementById('rationale-modal').style.display = 'flex';
        }

        // Close rationale modal
        function closeRationaleModal() {
            document.getElementById('rationale-modal').style.display = 'none';
        }

        // Add to portfolio
        async function addToPortfolio(symbol, sector) {
            try {
                const response = await fetch('/api/portfolio/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({symbol, sector, weight: 0})
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #22c55e; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; animation: slideIn 0.3s;';
                    notification.innerHTML = `<i class="fas fa-check-circle"></i> ${symbol} added to portfolio!`;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.animation = 'slideOut 0.3s';
                        setTimeout(() => notification.remove(), 300);
                    }, 3000);
                } else {
                    alert(`‚ùå ${data.message}`);
                }
            } catch (error) {
                console.error('Error adding to portfolio:', error);
                alert('‚ùå Error adding to portfolio');
            }
        }

        // Deploy to agent
        async function deployToAgent(symbol) {
            selectedSymbol = symbol;
            
            // Load agents
            try {
                const response = await fetch('/api/agents');
                const agents = await response.json();
                
                if (Object.keys(agents).length === 0) {
                    alert('‚ùå No agents available. Please create an agent first.');
                    return;
                }
                
                // Show agent selector
                const agentList = document.getElementById('agent-list');
                agentList.innerHTML = Object.entries(agents).map(([agentId, agent]) => {
                    const statusIcon = agent.running ? 'üü¢' : '‚ö™';
                    return `
                        <div onclick="selectAgentForDeploy('${agentId}')" style="background: #1a1a24; border: 2px solid #2d2d3d; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#2d2d3d'">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #fff; font-weight: 600;">${statusIcon} ${agent.name}</div>
                                    <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">${agent.asset_type} | ${agent.monitored_assets.length} assets</div>
                                </div>
                                <i class="fas fa-chevron-right" style="color: #6366f1;"></i>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('agent-selector-modal').style.display = 'flex';
            } catch (e) {
                console.error('Error loading agents:', e);
                alert('‚ùå Error loading agents');
            }
        }

        // Select agent for deploy
        async function selectAgentForDeploy(agentId) {
            try {
                const response = await fetch('/api/screener/deploy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        agent_id: agentId,
                        symbol: selectedSymbol
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    closeAgentSelector();
                    alert(`‚úÖ ${selectedSymbol} deployed to agent!`);
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (e) {
                console.error('Error deploying:', e);
                alert('‚ùå Error deploying to agent');
            }
        }

        // Close agent selector
        function closeAgentSelector() {
            document.getElementById('agent-selector-modal').style.display = 'none';
            selectedSymbol = null;
        }

        // View details (placeholder)
        function viewDetails(symbol) {
            alert(`Detailed analysis for ${symbol} coming soon!`);
        }
        
    </script>

    <style>
        .filter-tabs {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .filter-tab {
            background: #1a1a24;
            border: 2px solid #2d2d3d;
            border-radius: 8px;
            padding: 12px 20px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }
        
        .filter-tab:hover {
            border-color: #6366f1;
            color: #fff;
        }
        
        .filter-tab.active {
            background: #6366f1;
            border-color: #6366f1;
            color: #fff;
        }
        
        .opportunity-card {
            background: #1a1a24;
            border: 1px solid #2d2d3d;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }
        
        .opportunity-card:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }
        
        .opp-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2d2d3d;
        }
    </style>
</body>
</html>
