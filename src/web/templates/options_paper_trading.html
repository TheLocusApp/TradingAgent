<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGBot Trader - TradingView Webhook Integration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='modern-style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .trade-row {
            display: grid;
            grid-template-columns: 25px 85px 35px 65px 55px 55px 55px 55px 65px 70px 90px 60px;
            gap: 6px;
            padding: 10px;
            border-bottom: 1px solid #2d2d3d;
            font-size: 10px;
            align-items: center;
        }
        .trade-row:hover {
            background: rgba(99, 102, 241, 0.05);
        }
        .trade-header {
            font-weight: 600;
            color: #9ca3af;
            font-size: 9px;
            text-transform: uppercase;
        }
        .trade-type-long { color: #10b981; }
        .trade-type-short { color: #ef4444; }
        .trade-option-call { color: #10b981; font-weight: 600; }
        .trade-option-put { color: #ef4444; font-weight: 600; }
        .profit-positive { color: #10b981; }
        .profit-negative { color: #ef4444; }
        .webhook-message {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            background: #1a1a24;
            border-left: 3px solid #6366f1;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }
        .webhook-timestamp {
            color: #9ca3af;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .webhook-content {
            color: #fff;
        }
        .account-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: linear-gradient(135deg, #1a1a24 0%, #16162a 100%);
            border: 1px solid #2d2d3d;
            border-radius: 8px;
            padding: 15px;
        }
        .summary-label {
            color: #9ca3af;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .summary-value {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
        }
        .summary-change {
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="nav-links">
                <a href="/strategy-lab">BACKTEST LAB</a>
                <a href="/analyst">ANALYST</a>
                <a href="/">LIVE AGENTS</a>
                <a href="/portfolio">PORTFOLIO</a>
                <a href="/agbot-trader" class="active">AGBOT TRADER</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Account Performance Chart -->
        <div class="chart-section" style="height: 400px; display: flex; flex-direction: column; margin-bottom: 24px; overflow: hidden;">
            <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">
                <i class="fas fa-chart-line"></i> Account Performance
            </h2>
            <div style="flex: 1; position: relative; min-height: 0;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- List of Trades & Webhook Panel -->
        <div style="display: grid; grid-template-columns: 1.95fr 1fr; gap: 20px; margin-bottom: 24px;">
            <!-- List of Trades -->
            <div class="chart-section" style="display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin: 0;">
                        <i class="fas fa-list"></i> List of Trades
                    </h2>
                    <button id="export-csv-btn" style="background: #6366f1; border: none; color: #fff; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" title="Export CSV">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                
                <!-- Trade Header -->
                <div class="trade-row trade-header">
                    <div>#</div>
                    <div>Date/Time</div>
                    <div>TF</div>
                    <div>Signal</div>
                    <div>Option</div>
                    <div>Strike</div>
                    <div>Expiry</div>
                    <div>Price</div>
                    <div>Contracts</div>
                    <div>Realized P&L</div>
                    <div>Unrealized P&L</div>
                    <div>TF Cum. P&L</div>
                </div>
                
                <!-- Trade Rows -->
                <div id="trades-container" style="flex: 1; overflow-y: auto; max-height: 500px;">
                    <div style="padding: 40px; text-align: center; color: #6b7280;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>No trades yet. Waiting for signals...</p>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2d2d3d;">
                    <button id="prev-page-btn" style="background: #2d2d3d; border: none; color: #9ca3af; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚Üê Previous</button>
                    <span id="page-info" style="color: #9ca3af; font-size: 12px;">Page 1</span>
                    <button id="next-page-btn" style="background: #2d2d3d; border: none; color: #9ca3af; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Next ‚Üí</button>
                </div>
            </div>
            
            <!-- Webhook Notifications Panel -->
            <div class="chart-section" style="display: flex; flex-direction: column; height: 700px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin: 0;">
                        <i class="fas fa-bell"></i> Notifications
                    </h2>
                    <button id="strategy-config-btn" style="background: none; border: none; color: #6366f1; cursor: pointer; font-size: 18px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
                
                <!-- Webhook Messages -->
                <div id="webhook-container" style="flex: 1; overflow-y: auto; padding-right: 8px;">
                    <div style="padding: 40px; text-align: center; color: #6b7280;">
                        <i class="fas fa-satellite-dish" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>Listening for TradingView webhooks...</p>
                        <p style="font-size: 12px; margin-top: 8px;">Configure your Pine Script alerts to send signals here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AGBot Performance Table -->
        <div class="chart-section" style="margin-bottom: 24px;">
            <h2 style="font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 20px;">
                <i class="fas fa-chart-bar"></i> AGBot Performance
            </h2>
            
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; color: #fff; font-size: 13px;">
                    <thead>
                        <tr style="border-bottom: 2px solid #2d2d3d;">
                            <th style="padding: 12px; text-align: left; color: #9ca3af; font-weight: 600;">Timeframe</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Total P&L</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Win Rate</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;"># Trades</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Avg Win</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Avg Loss</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Best Trade</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Worst Trade</th>
                            <th style="padding: 12px; text-align: right; color: #9ca3af; font-weight: 600;">Profit Factor</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body">
                        <tr style="border-bottom: 1px solid #2d2d3d;">
                            <td colspan="9" style="padding: 20px; text-align: center; color: #6b7280;">No trades yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Strategy Configuration Modal -->
        <div id="strategy-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: #0f0f1e; border: 1px solid #2d2d3d; border-radius: 12px; padding: 30px; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h2 style="font-size: 24px; font-weight: 600; color: #fff; margin: 0;">
                        <i class="fas fa-info-circle"></i> Strategy Configuration
                    </h2>
                    <button id="close-strategy-modal" style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 24px; padding: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- LONGS Configuration -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #10b981; font-size: 16px; font-weight: 600; margin-bottom: 12px;">üìà LONG (META Exact)</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Stop Loss Type</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">ATR / Swing Low</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">TP1 R:R</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">1.0</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">TP2 R:R</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">3.0</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">TP1 Close %</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">35%</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Swing Low Bars</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">10</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">ATR Multiplier</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">2.0</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Regime Filter</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">None</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">EMA Filter</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">None</div>
                        </div>
                    </div>
                </div>
                
                <!-- SHORTS Configuration -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #ef4444; font-size: 16px; font-weight: 600; margin-bottom: 12px;">üìâ SHORT (Swing High Optimized)</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Stop Loss Type</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">Swing High</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">TP1 R:R</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">1.5</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">TP2 R:R</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">3.0</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">TP1 Close %</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">70%</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Swing High Bars</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">5</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">EMA Filter</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">13/48/200</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Regime Detection</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">SMA 50/200</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Bull Risk Reduction</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">50%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Common Settings -->
                <div style="padding-top: 20px; border-top: 1px solid #2d2d3d;">
                    <h3 style="color: #6366f1; font-size: 16px; font-weight: 600; margin-bottom: 12px;">‚öôÔ∏è Common Settings</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Risk per Trade</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">2.5%</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Contracts per Trade</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">3</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">DTE (Days to Expiry)</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">5</div>
                        </div>
                        <div>
                            <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Strike Selection</div>
                            <div style="color: #fff; font-size: 16px; font-weight: 600;">ATM / 1 ITM</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let accountBalance = 10000;
        let initialBalance = 10000;
        let trades = [];
        let openPositions = [];
        let performanceChart = null;
        let performanceDataByTimeframe = {}; // Store data by timeframe

        // Initialize performance chart
        function initPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#fff'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#9ca3af',
                            borderColor: '#2d2d3d',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            ticks: { 
                                color: '#9ca3af'
                            },
                            grid: { color: '#2d2d3d' },
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#9ca3af',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            ticks: { 
                                color: '#9ca3af',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: '#2d2d3d' },
                            title: {
                                display: true,
                                text: 'Balance ($)',
                                color: '#fff',
                                font: {
                                    size: 12
                                }
                            },
                            min: 9000,
                            suggestedMax: 11000
                        }
                    }
                }
            });
        }

        // Format number with commas
        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString('en-US');
        }

        // Update performance chart with timeframe data
        function updatePerformanceChart() {
            try {
                // Group trades by timeframe
                const byTimeframe = {};
                trades.forEach(trade => {
                    const tf = trade.timeframe || 'N/A';
                    if (!byTimeframe[tf]) {
                        byTimeframe[tf] = [];
                    }
                    byTimeframe[tf].push(trade);
                });
                
                // Create datasets for each timeframe
                const datasets = [];
                const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];
                let colorIndex = 0;
                
                const timeframes = Object.keys(byTimeframe).sort();
                
                timeframes.forEach(tf => {
                    const tfTrades = byTimeframe[tf];
                    const balanceData = [{x: new Date(), y: initialBalance}];
                    let runningBalance = initialBalance;
                    
                    tfTrades.forEach(trade => {
                        runningBalance += trade.pnl;
                        balanceData.push({
                            x: new Date(trade.exitTime),
                            y: runningBalance
                        });
                    });
                    
                    datasets.push({
                        label: `${tf} Timeframe`,
                        data: balanceData,
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '20',
                        tension: 0.4,
                        fill: false
                    });
                    colorIndex++;
                });
                
                // Generate timestamps from all trades
                const allTimestamps = trades.map(t => new Date(t.exitTime)).sort((a, b) => a - b);
                
                // Update chart
                performanceChart.data.datasets = datasets;
                performanceChart.update('none');
            } catch (e) {
                console.error('Error updating performance chart:', e);
            }
        }

        // Add trade to list
        function addTrade(trade) {
            trades.push(trade);
            
            // Update account balance
            accountBalance += trade.pnl;
            
            // Update chart
            updatePerformanceChart();
            
            // Add to trades list
            renderTrades();
        }

        // Pagination state
        let currentPage = 1;
        const tradesPerPage = 10;

        // Render trades list with pagination
        function renderTrades() {
            const container = document.getElementById('trades-container');
            
            // Combine closed trades and open positions
            const allTrades = [...trades, ...openPositions];
            
            console.log('üéØ renderTrades called:', {
                trades_count: trades.length,
                openPositions_count: openPositions.length,
                allTrades_count: allTrades.length,
                container_exists: !!container
            });
            
            if (allTrades.length === 0) {
                console.log('‚ö†Ô∏è No trades to display');
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #6b7280;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>No trades yet. Waiting for signals...</p>
                    </div>
                `;
                updatePaginationInfo();
                return;
            }
            
            console.log('‚úÖ Rendering', allTrades.length, 'trades');
            
            // Sort trades by newest first
            const sortedTrades = [...allTrades].reverse();
            
            // Calculate pagination
            const totalPages = Math.ceil(sortedTrades.length / tradesPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            const startIdx = (currentPage - 1) * tradesPerPage;
            const endIdx = startIdx + tradesPerPage;
            const pageTrades = sortedTrades.slice(startIdx, endIdx);
            
            let html = '';
            let timeframeCumulativePnL = {};
            
            // Calculate cumulative P&L for each timeframe
            const sortedAllTradesForPnL = [...allTrades].reverse();
            sortedAllTradesForPnL.forEach(trade => {
                const tf = trade.timeframe || 'N/A';
                if (!timeframeCumulativePnL[tf]) {
                    timeframeCumulativePnL[tf] = 0;
                }
                timeframeCumulativePnL[tf] += (trade.pnl || 0);
            });
            
            pageTrades.forEach((trade, pageIndex) => {
                const actualIndex = sortedTrades.indexOf(trade) + 1;
                
                // Map backend field names to frontend expectations
                const exitTime = trade.exit_time || trade.exitTime || trade.entry_time || 'N/A';
                const signal = trade.signal || trade.type || trade.action || 'N/A';
                const optionType = trade.option_type || trade.option || 'Call';
                const optionClass = optionType.toLowerCase().includes('call') ? 'trade-option-call' : 'trade-option-put';
                const price = trade.exit_price || trade.entry_price || trade.price || 0;
                const strike = trade.strike || 0;
                const expiry = trade.expiry || 'N/A';
                const contracts = trade.contracts || 0;
                
                const realizedPnl = trade.pnl || 0;
                const unrealizedPnl = trade.unrealizedPnl || 0;
                const realizedPnlClass = realizedPnl >= 0 ? 'profit-positive' : 'profit-negative';
                const unrealizedPnlClass = unrealizedPnl >= 0 ? 'profit-positive' : 'profit-negative';
                const timeframe = trade.timeframe || 'N/A';
                const tfCumPnL = timeframeCumulativePnL[timeframe] || 0;
                const tfCumPnLClass = tfCumPnL >= 0 ? 'profit-positive' : 'profit-negative';
                
                html += `
                    <div class="trade-row">
                        <div>${actualIndex}</div>
                        <div>${exitTime}</div>
                        <div>${timeframe}</div>
                        <div>${signal}</div>
                        <div class="${optionClass}">${optionType}</div>
                        <div>$${Math.round(strike).toLocaleString('en-US')}</div>
                        <div>${expiry}</div>
                        <div>$${price.toFixed(2)}</div>
                        <div>${contracts}</div>
                        <div class="${realizedPnlClass}">${realizedPnl >= 0 ? '+' : ''}$${Math.round(Math.abs(realizedPnl)).toLocaleString('en-US')}</div>
                        <div class="${unrealizedPnlClass}">${unrealizedPnl >= 0 ? '+' : ''}$${Math.round(Math.abs(unrealizedPnl)).toLocaleString('en-US')}</div>
                        <div class="${tfCumPnLClass}">${tfCumPnL >= 0 ? '+' : ''}$${Math.round(Math.abs(tfCumPnL)).toLocaleString('en-US')}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updatePaginationInfo();
            updateComparisonTable();
        }

        // Update pagination info
        function updatePaginationInfo() {
            const allTrades = [...trades, ...openPositions];
            const totalPages = Math.ceil(allTrades.length / tradesPerPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Export trades to CSV
        function exportToCSV() {
            if (trades.length === 0) {
                alert('No trades to export');
                return;
            }
            
            const headers = ['#', 'Type', 'Date/Time', 'Timeframe', 'Signal', 'Option', 'Strike', 'Expiry', 'Price', 'Contracts', 'Net P&L', 'Cumulative P&L'];
            let csv = headers.join(',') + '\n';
            
            let cumulativePnL = 0;
            trades.forEach((trade, index) => {
                cumulativePnL += trade.pnl;
                csv += [
                    index + 1,
                    trade.type,
                    trade.exitTime,
                    trade.timeframe || 'N/A',
                    trade.signal,
                    trade.option,
                    Math.round(trade.strike),
                    trade.expiry,
                    trade.price.toFixed(2),
                    trade.contracts,
                    trade.pnl.toFixed(2),
                    cumulativePnL.toFixed(2)
                ].join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `agbot-trades-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Update comparison table
        function updateComparisonTable() {
            const tbody = document.getElementById('comparison-table-body');
            
            // Combine closed trades and open positions for display
            const allTrades = [...trades, ...openPositions];
            
            if (allTrades.length === 0) {
                tbody.innerHTML = '<tr style="border-bottom: 1px solid #2d2d3d;"><td colspan="9" style="padding: 20px; text-align: center; color: #6b7280;">No trades yet</td></tr>';
                return;
            }
            
            // Group trades by timeframe
            const byTimeframe = {};
            allTrades.forEach(trade => {
                const tf = trade.timeframe || 'N/A';
                if (!byTimeframe[tf]) {
                    byTimeframe[tf] = [];
                }
                byTimeframe[tf].push(trade);
            });
            
            let html = '';
            Object.keys(byTimeframe).sort().forEach(tf => {
                const tfTrades = byTimeframe[tf];
                const wins = tfTrades.filter(t => t.pnl > 0).length;
                const losses = tfTrades.filter(t => t.pnl < 0).length;
                const totalPnL = tfTrades.reduce((sum, t) => sum + t.pnl, 0);
                const winRate = tfTrades.length > 0 ? ((wins / tfTrades.length) * 100).toFixed(0) : 0;
                const avgWin = wins > 0 ? (tfTrades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0) / wins).toFixed(0) : 0;
                const avgLoss = losses > 0 ? (tfTrades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0) / losses).toFixed(0) : 0;
                const bestTrade = Math.max(...tfTrades.map(t => t.pnl)).toFixed(0);
                const worstTrade = Math.min(...tfTrades.map(t => t.pnl)).toFixed(0);
                const profitFactor = losses > 0 ? (tfTrades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0) / Math.abs(tfTrades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0))).toFixed(2) : (wins > 0 ? '‚àû' : '0');
                
                const pnlClass = totalPnL >= 0 ? 'profit-positive' : 'profit-negative';
                
                html += `
                    <tr style="border-bottom: 1px solid #2d2d3d;">
                        <td style="padding: 12px; text-align: left;">${tf}</td>
                        <td style="padding: 12px; text-align: right; color: ${totalPnL >= 0 ? '#10b981' : '#ef4444'};">${totalPnL >= 0 ? '+' : ''}$${Math.round(totalPnL).toLocaleString('en-US')}</td>
                        <td style="padding: 12px; text-align: right;">${winRate}%</td>
                        <td style="padding: 12px; text-align: right;">${tfTrades.length}</td>
                        <td style="padding: 12px; text-align: right; color: #10b981;">+$${avgWin}</td>
                        <td style="padding: 12px; text-align: right; color: #ef4444;">-$${Math.abs(avgLoss)}</td>
                        <td style="padding: 12px; text-align: right; color: #10b981;">+$${bestTrade}</td>
                        <td style="padding: 12px; text-align: right; color: #ef4444;">-$${Math.abs(worstTrade)}</td>
                        <td style="padding: 12px; text-align: right;">${profitFactor}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Format webhook notification (compact view)
        function formatWebhookNotification(message) {
            const date = new Date(message.timestamp);
            const dateStr = date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            // Determine type (LONG/SHORT/CLOSE/TP1/TP2/SL)
            let type = '';
            let typeColor = '#6b7280';
            
            // Check all possible fields for TP/SL indicators
            const allFields = JSON.stringify(message).toUpperCase();
            
            if (allFields.includes('TP1') || allFields.includes('TAKE_PROFIT_1')) {
                type = 'TP1';
                typeColor = '#8b5cf6';
            } else if (allFields.includes('TP2') || allFields.includes('TAKE_PROFIT_2')) {
                type = 'TP2';
                typeColor = '#8b5cf6';
            } else if (allFields.includes('SL') || allFields.includes('STOP_LOSS')) {
                type = 'SL';
                typeColor = '#ec4899';
            } else if (message.action === 'buy' && message.market_position === 'long') {
                type = 'LONG';
                typeColor = '#10b981';
            } else if (message.action === 'sell' && message.market_position === 'short') {
                type = 'SHORT';
                typeColor = '#ef4444';
            } else if (message.action === 'sell' && message.market_position === 'long') {
                type = 'EXIT';
                typeColor = '#f59e0b';
            } else if (message.action === 'close' || message.market_position === 'flat') {
                type = 'CLOSE';
                typeColor = '#f59e0b';
            } else if (message.action === 'buy') {
                type = 'BUY';
                typeColor = '#10b981';
            } else if (message.action === 'sell') {
                type = 'SELL';
                typeColor = '#ef4444';
            }
            
            const price = Math.round(parseFloat(message.price)).toLocaleString('en-US');
            
            return {
                dateStr,
                timeStr,
                type,
                typeColor,
                price
            };
        }

        // Add webhook message
        function addWebhookMessage(message) {
            const container = document.getElementById('webhook-container');
            const formatted = formatWebhookNotification(message);
            const timeframe = message.timeframe || 'N/A';
            
            const messageHtml = `
                <div class="webhook-message" data-timestamp="${message.timestamp}" style="padding: 10px; background: #1a1a24; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${formatted.typeColor}; display: grid; grid-template-columns: 100px 60px 60px 90px 70px; gap: 8px; align-items: center; font-size: 12px;">
                    <div style="color: #9ca3af;">${formatted.dateStr} ${formatted.timeStr}</div>
                    <div style="color: #fff; font-weight: 600;">${message.ticker}</div>
                    <div style="color: #6366f1; font-weight: 600; background: rgba(99, 102, 241, 0.2); padding: 2px 6px; border-radius: 3px; text-align: center;">${timeframe}</div>
                    <div style="color: #fbbf24;">$${formatted.price}</div>
                    <div style="color: ${formatted.typeColor}; font-weight: 600;">${formatted.type}</div>
                </div>
            `;
            
            // Clear placeholder only on first message
            if (container.querySelector('.fas.fa-satellite-dish')) {
                container.innerHTML = '';
            }
            
            // Add new message at the top (preserve previous notifications)
            container.insertAdjacentHTML('afterbegin', messageHtml);
        }

        // Process webhook signal
        function processWebhook(data) {
            addWebhookMessage(data);
            
            // TODO: Parse webhook data and create trade
            // This will be implemented based on the webhook format we decide
            console.log('Received webhook:', data);
        }

        // Load state from backend
        function loadState() {
            fetch('/api/paper-trading/state')
                .then(response => response.json())
                .then(data => {
                    console.log('üìä State loaded:', {
                        account_balance: data.account_balance,
                        initial_balance: data.initial_balance,
                        trades_count: (data.trades || []).length,
                        open_positions_count: (data.open_positions || []).length,
                        webhooks_count: (data.webhooks || []).length
                    });
                    
                    accountBalance = data.account_balance;
                    initialBalance = data.initial_balance;
                    trades = data.trades || [];
                    openPositions = data.open_positions || [];
                    
                    console.log('‚úÖ openPositions set to:', openPositions.length, 'positions');
                    
                    // Update UI
                    updatePerformanceChart();
                    renderTrades();
                    
                    // Load webhooks (reverse to maintain newest-first order)
                    if (data.webhooks && data.webhooks.length > 0) {
                        data.webhooks.slice().reverse().forEach(webhook => {
                            addWebhookMessage(webhook);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading state:', error);
                });
        }

        // Poll for new webhooks
        function pollWebhooks() {
            setInterval(() => {
                fetch('/api/paper-trading/state')
                    .then(response => response.json())
                    .then(data => {
                        // Check for new webhooks
                        if (data.webhooks && data.webhooks.length > 0) {
                            const latestWebhook = data.webhooks[0];
                            const webhookContainer = document.getElementById('webhook-container');
                            const firstMessage = webhookContainer.querySelector('.webhook-message');
                            
                            // Only add if it's new (compare timestamps)
                            if (!firstMessage || firstMessage.dataset.timestamp !== latestWebhook.timestamp) {
                                addWebhookMessage(latestWebhook);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error polling webhooks:', error);
                    });
            }, 2000); // Poll every 2 seconds
        }

        // Modal controls
        const strategyModal = document.getElementById('strategy-modal');
        const strategyConfigBtn = document.getElementById('strategy-config-btn');
        const closeStrategyModalBtn = document.getElementById('close-strategy-modal');
        
        strategyConfigBtn.addEventListener('click', function() {
            strategyModal.style.display = 'flex';
        });
        
        closeStrategyModalBtn.addEventListener('click', function() {
            strategyModal.style.display = 'none';
        });
        
        // Close modal when clicking outside
        strategyModal.addEventListener('click', function(e) {
            if (e.target === strategyModal) {
                strategyModal.style.display = 'none';
            }
        });
        
        // Add hover effect to strategy button
        strategyConfigBtn.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(99, 102, 241, 0.1)';
        });
        
        strategyConfigBtn.addEventListener('mouseleave', function() {
            this.style.background = 'none';
        });

        // Pagination event listeners
        document.getElementById('prev-page-btn').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderTrades();
            }
        });

        document.getElementById('next-page-btn').addEventListener('click', function() {
            const totalPages = Math.ceil(trades.length / tradesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTrades();
            }
        });

        // CSV export event listener
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initPerformanceChart();
            loadState();
            pollWebhooks();
        });
    </script>
</body>
</html>
